{% extends "base.html" %}
{% load static %}

{% block title %}Mis Eventos - Experienciaas{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center justify-content-between flex-wrap">
        <div class="mb-3 mb-md-0">
          <h1 class="h3 fw-bold mb-1">Mis Eventos</h1>
          <p class="text-muted mb-0">Gestiona tus eventos registrados</p>
        </div>
        <div class="d-flex gap-2">
          <!-- View Toggle -->
          <div class="btn-group" role="group" aria-label="Tipo de vista">
            <input type="radio" class="btn-check" name="viewType" id="listView" autocomplete="off" checked>
            <label class="btn btn-outline-secondary" for="listView">
              <i class="fas fa-list me-1"></i>Lista
            </label>
            
            <input type="radio" class="btn-check" name="viewType" id="calendarView" autocomplete="off">
            <label class="btn btn-outline-secondary" for="calendarView">
              <i class="fas fa-calendar-alt me-1"></i>Calendario
            </label>
          </div>
          
          <a href="{% url 'events:list' %}" class="btn btn-outline-primary">
            <i class="fas fa-plus me-1"></i>Buscar Eventos
          </a>
        </div>
      </div>
    </div>
  </div>

  {% if tickets %}
    <!-- Quick Stats -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card border-0 bg-light">
          <div class="card-body py-3">
            <div class="row text-center">
              <div class="col-6 col-md-3">
                <div class="d-flex flex-column">
                  <span class="h5 mb-0 text-primary fw-bold">{{ stats.total }}</span>
                  <small class="text-muted">Total</small>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="d-flex flex-column">
                  <span class="h5 mb-0 text-success fw-bold">{{ stats.confirmed }}</span>
                  <small class="text-muted">Confirmados</small>
                </div>
              </div>
              <div class="col-6 col-md-3 mt-2 mt-md-0">
                <div class="d-flex flex-column">
                  <span class="h5 mb-0 text-info fw-bold">{{ stats.upcoming }}</span>
                  <small class="text-muted">Próximos</small>
                </div>
              </div>
              <div class="col-6 col-md-3 mt-2 mt-md-0">
                <div class="d-flex flex-column">
                  <span class="h5 mb-0 text-warning fw-bold">{{ stats.pending }}</span>
                  <small class="text-muted">Pendientes</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters and Search (shown in both views) -->
    <div class="row mb-4" id="filters-section">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-body py-3">
            <form method="get" class="filter-form">
              <div class="row g-3 align-items-center">
                <div class="col-md-4">
                  <div class="input-group">
                    <span class="input-group-text bg-white border-end-0">
                      <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" name="search" class="form-control border-start-0" 
                           placeholder="Buscar por nombre del evento..." 
                           value="{{ current_search }}">
                  </div>
                </div>
                
                <div class="col-md-2">
                  <select name="status" class="form-select">
                    <option value="">Estado</option>
                    <option value="confirmed" {% if current_status_filter == 'confirmed' %}selected{% endif %}>Confirmado</option>
                    <option value="pending" {% if current_status_filter == 'pending' %}selected{% endif %}>Pendiente</option>
                    <option value="cancelled" {% if current_status_filter == 'cancelled' %}selected{% endif %}>Cancelado</option>
                  </select>
                </div>
                
                <div class="col-md-2">
                  <select name="time_filter" class="form-select">
                    <option value="">Período</option>
                    <option value="upcoming" {% if current_time_filter == 'upcoming' %}selected{% endif %}>Próximos</option>
                    <option value="past" {% if current_time_filter == 'past' %}selected{% endif %}>Pasados</option>
                    <option value="today" {% if current_time_filter == 'today' %}selected{% endif %}>Hoy</option>
                    <option value="this_week" {% if current_time_filter == 'this_week' %}selected{% endif %}>Esta semana</option>
                  </select>
                </div>
                
                <div class="col-md-2">
                  <select name="sort" class="form-select">
                    <option value="-created_at" {% if request.GET.sort == '-created_at' or not request.GET.sort %}selected{% endif %}>Más recientes</option>
                    <option value="event__start_date" {% if request.GET.sort == 'event__start_date' %}selected{% endif %}>Por fecha evento</option>
                    <option value="event__title" {% if request.GET.sort == 'event__title' %}selected{% endif %}>Por nombre</option>
                  </select>
                </div>
                
                <div class="col-md-2">
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary btn-sm">
                      <i class="fas fa-filter"></i>
                    </button>
                    <a href="{% url 'events:my_events' %}" class="btn btn-outline-secondary btn-sm">
                      <i class="fas fa-times"></i>
                    </a>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- View Info -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center">
        <span class="text-muted me-3">{{ tickets|length }} evento{{ tickets|length|pluralize }}</span>
        {% if current_search %}
          <span class="badge bg-primary me-2">Filtrado por: "{{ current_search }}"</span>
        {% endif %}
        {% if current_status_filter %}
          <span class="badge bg-secondary me-2">Estado: {{ current_status_filter|capfirst }}</span>
        {% endif %}
        {% if current_time_filter and current_time_filter != 'upcoming' %}
          <span class="badge bg-info">
            {% if current_time_filter == 'past' %}Pasados
            {% elif current_time_filter == 'today' %}Hoy
            {% elif current_time_filter == 'this_week' %}Esta semana
            {% endif %}
          </span>
        {% endif %}
      </div>
    </div>

    <!-- Events List View -->
    <div id="list-view">
      <!-- Events List -->
      <div id="events-container">
        {% if tickets %}
          {% for ticket in tickets %}
            <div class="card border-0 shadow-sm mb-3 event-card">
              <div class="card-body p-3">
                <div class="row align-items-center">
                  <!-- Event Image -->
                  <div class="col-auto">
                    <div class="event-image-mini">
                      {% if ticket.event.image %}
                        <img src="{{ ticket.event.image.url }}" alt="{{ ticket.event.title }}" class="rounded">
                      {% else %}
                        <img src="{{ MEDIA_URL }}events/default/general_event.png" alt="{{ ticket.event.title }}" class="rounded">
                      {% endif %}
                    </div>
                  </div>
                  
                  <!-- Event Info -->
                  <div class="col">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="d-flex align-items-start">
                          <div class="flex-grow-1">
                            <h6 class="mb-1 fw-semibold">
                              <a href="{{ ticket.event.get_absolute_url }}" class="text-decoration-none text-dark">
                                {{ ticket.event.title }}
                              </a>
                            </h6>
                            <div class="d-flex align-items-center text-muted small mb-1">
                              <i class="fas fa-calendar-alt me-1"></i>
                              <span>{{ ticket.event.start_date|date:"d M Y, H:i" }}</span>
                            </div>
                            <div class="d-flex align-items-center text-muted small">
                              <i class="fas fa-map-marker-alt me-1"></i>
                              <span>{{ ticket.event.city.name }}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <div class="col-md-3">
                        <div class="text-center text-md-start">
                          <!-- Estado de la compra/aplicación -->
                          <div class="mb-2">
                            <div class="d-flex align-items-center justify-content-center justify-content-md-start mb-1">
                              <i class="fas fa-ticket-alt me-1 text-muted" style="font-size: 0.8rem;"></i>
                              <small class="text-muted fw-medium">Estado del Ticket</small>
                            </div>
                            <span class="badge {% if ticket.status == 'confirmed' %}bg-success{% elif ticket.status == 'pending' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                              {% if ticket.status == 'confirmed' %}
                                <i class="fas fa-check-circle me-1"></i>{{ ticket.get_status_display }}
                              {% elif ticket.status == 'pending' %}
                                <i class="fas fa-clock me-1"></i>{{ ticket.get_status_display }}
                              {% else %}
                                <i class="fas fa-times-circle me-1"></i>{{ ticket.get_status_display }}
                              {% endif %}
                            </span>
                          </div>
                          
                          <!-- Información del ticket -->
                          <div class="small text-muted mb-1">
                            <strong>#{{ ticket.ticket_number }}</strong>
                          </div>
                          
                          <!-- Precio -->
                          <div class="fw-semibold {% if ticket.amount_paid == 0 %}text-success{% else %}text-primary{% endif %}">
                            {% if ticket.amount_paid == 0 %}
                              <i class="fas fa-gift me-1"></i>GRATIS
                            {% else %}
                              <i class="fas fa-tag me-1"></i>{{ ticket.event.currency }} {{ ticket.amount_paid }}
                            {% endif %}
                          </div>
                        </div>
                      </div>
                      
                      <div class="col-md-3">
                        <div class="d-flex justify-content-end gap-2">
                          <a href="{{ ticket.event.get_absolute_url }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye"></i>
                          </a>
                          {% if ticket.status == 'confirmed' %}
                            <button class="btn btn-outline-secondary btn-sm" onclick="downloadTicket('{{ ticket.ticket_number }}')" title="Descargar ticket">
                              <i class="fas fa-download"></i>
                            </button>
                          {% endif %}
                          <div class="dropdown">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                              <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                              <li><a class="dropdown-item" href="{{ ticket.event.get_absolute_url }}">Ver evento</a></li>
                              <li><a class="dropdown-item" href="#">Compartir</a></li>
                              {% if ticket.status == 'confirmed' %}
                                <li><a class="dropdown-item" href="#" onclick="downloadTicket('{{ ticket.ticket_number }}')">Descargar ticket</a></li>
                              {% endif %}
                            </ul>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Event Status Timeline -->
                <div class="mt-3 pt-3 border-top">
                  <div class="row align-items-center">
                    <div class="col-auto">
                      <div class="d-flex align-items-center">
                        <i class="fas fa-calendar-check me-2 text-muted" style="font-size: 0.9rem;"></i>
                        <small class="text-muted fw-medium">Estado del Evento:</small>
                      </div>
                    </div>
                    <div class="col">
                      {% now "Y-m-d H:i" as current_time %}
                      {% if ticket.event.start_date|date:"Y-m-d H:i" < current_time %}
                        <span class="badge bg-dark">
                          <i class="fas fa-flag-checkered me-1"></i>FINALIZADO
                        </span>
                        <small class="text-muted ms-2">
                          Evento terminado el {{ ticket.event.start_date|date:"d/m/Y" }}
                        </small>
                      {% elif ticket.event.start_date|date:"Y-m-d" == current_time|date:"Y-m-d" %}
                        <span class="badge bg-danger">
                          <i class="fas fa-calendar-day me-1"></i>HOY
                        </span>
                        <small class="text-danger fw-bold ms-2">
                          ¡El evento es hoy a las {{ ticket.event.start_date|date:"H:i" }}!
                        </small>
                      {% else %}
                        {% comment %} Calcular si es en los próximos 7 días {% endcomment %}
                        {% if ticket.event.start_date|timeuntil|slice:":1" == "0" or "día" in ticket.event.start_date|timeuntil and "7 día" not in ticket.event.start_date|timeuntil|slice:"3:" %}
                          <span class="badge bg-warning text-dark">
                            <i class="fas fa-clock me-1"></i>PRÓXIMO
                          </span>
                          <small class="text-warning-emphasis fw-medium ms-2">
                            Faltan {{ ticket.event.start_date|timeuntil }}
                          </small>
                        {% else %}
                          <span class="badge bg-info">
                            <i class="fas fa-calendar-plus me-1"></i>PROGRAMADO
                          </span>
                          <small class="text-info ms-2">
                            En {{ ticket.event.start_date|timeuntil }}
                          </small>
                        {% endif %}
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <!-- No events message -->
          <div class="text-center py-5">
            {% if has_any_events %}
              <!-- User has events but filters don't match -->
              <div class="empty-state no-filtered-events-state">
                <div class="fa-stack">
                  <i class="fas fa-circle fa-stack-2x text-info"></i>
                  <i class="fas fa-filter fa-stack-1x fa-inverse"></i>
                </div>
                <h5 class="text-info mb-3">No se encontraron eventos</h5>
                <p class="text-muted mb-3">
                  No hay eventos que coincidan con los filtros aplicados.
                  <br>
                  <small>Tienes eventos registrados, pero no cumplen con los criterios de búsqueda actuales.</small>
                </p>
                <div class="d-flex justify-content-center gap-2 flex-wrap">
                  <a href="{% url 'events:my_events' %}" class="btn btn-info">
                    <i class="fas fa-times me-2"></i>Limpiar filtros
                  </a>
                  <a href="{% url 'events:list' %}" class="btn btn-outline-info">
                    <i class="fas fa-plus me-2"></i>Buscar más eventos
                  </a>
                </div>
              </div>
            {% else %}
              <!-- User has no events at all -->
              <div class="empty-state no-events-state">
                <div class="fa-stack">
                  <i class="fas fa-circle fa-stack-2x text-warning"></i>
                  <i class="fas fa-calendar-plus fa-stack-1x fa-inverse"></i>
                </div>
                <h5 class="text-warning mb-3">No tienes eventos registrados</h5>
                <p class="text-muted mb-3">¡Explora nuestra plataforma y encuentra eventos increíbles cerca de ti!</p>
                <a href="{% url 'events:list' %}" class="btn btn-warning">
                  <i class="fas fa-plus me-2"></i>Explorar eventos
                </a>
              </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Calendar View -->
    <div id="calendar-view" style="display: none;">
      {% if tickets %}
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <!-- Calendar Header -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="d-flex align-items-center gap-3">
                <button id="prevMonth" class="btn btn-outline-secondary btn-sm">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <h5 id="currentMonth" class="mb-0 fw-bold"></h5>
                <button id="nextMonth" class="btn btn-outline-secondary btn-sm">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
              <div class="d-flex gap-2">
                <button id="todayBtn" class="btn btn-outline-primary btn-sm">Hoy</button>
                <div class="btn-group" role="group">
                  <input type="radio" class="btn-check" name="calendarViewType" id="monthView" autocomplete="off" checked>
                  <label class="btn btn-outline-secondary btn-sm" for="monthView">Mes</label>
                  
                  <input type="radio" class="btn-check" name="calendarViewType" id="weekView" autocomplete="off">
                  <label class="btn btn-outline-secondary btn-sm" for="weekView">Semana</label>
                </div>
              </div>
            </div>
            
            <!-- Calendar Grid -->
            <div id="calendar-container">
              <div id="calendar-grid" class="calendar-grid">
                <!-- Calendar will be generated by JavaScript -->
              </div>
            </div>
            
            <!-- Calendar Legend -->
            <div class="mt-3 pt-3 border-top">
              <div class="row">
                <div class="col-md-6">
                  <small class="text-muted fw-medium d-block mb-2">
                    <i class="fas fa-ticket-alt me-1"></i>Estado del Ticket:
                  </small>
                  <div class="d-flex flex-wrap gap-3">
                    <div class="d-flex align-items-center">
                      <div class="status-dot bg-success me-1"></div>
                      <small>Confirmado</small>
                    </div>
                    <div class="d-flex align-items-center">
                      <div class="status-dot bg-warning me-1"></div>
                      <small>Pendiente</small>
                    </div>
                    <div class="d-flex align-items-center">
                      <div class="status-dot bg-secondary me-1"></div>
                      <small>Cancelado</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-6 mt-2 mt-md-0">
                  <small class="text-muted fw-medium d-block mb-2">
                    <i class="fas fa-calendar-check me-1"></i>Estado del Evento:
                  </small>
                  <div class="d-flex flex-wrap gap-3">
                    <div class="d-flex align-items-center">
                      <div class="status-dot bg-danger me-1"></div>
                      <small>Hoy</small>
                    </div>
                    <div class="d-flex align-items-center">
                      <div class="status-dot bg-warning me-1"></div>
                      <small>Próximo</small>
                    </div>
                    <div class="d-flex align-items-center">
                      <div class="status-dot bg-info me-1"></div>
                      <small>Programado</small>
                    </div>
                    <div class="d-flex align-items-center">
                      <div class="status-dot bg-dark me-1"></div>
                      <small>Finalizado</small>
                    </div>
                  </div>
                </div>
              </div>
              <div class="text-center mt-3">
                <small class="text-muted">
                  <i class="fas fa-info-circle me-1"></i>
                  Haz clic en un evento para ir a su página de detalles
                </small>
              </div>
            </div>
          </div>
        </div>
      {% else %}
        <!-- No Events in Calendar -->
        <div class="text-center py-5">
          {% if has_any_events %}
            <!-- User has events but filters don't match -->
            <div class="empty-state no-filtered-events-state">
              <div class="fa-stack">
                <i class="fas fa-circle fa-stack-2x text-info"></i>
                <i class="fas fa-calendar-times fa-stack-1x fa-inverse"></i>
              </div>
              <h3 class="text-info mb-3">No hay eventos en el calendario</h3>
              <p class="text-muted mb-4">
                No se encontraron eventos que coincidan con los filtros aplicados.
                <br>
                <small class="text-muted">Tienes eventos registrados, pero no cumplen con los criterios actuales.</small>
              </p>
              <div class="d-flex justify-content-center gap-3 flex-wrap">
                <a href="{% url 'events:my_events' %}" class="btn btn-info btn-lg">
                  <i class="fas fa-list me-2"></i>Ver todos mis eventos
                </a>
                <a href="{% url 'events:list' %}" class="btn btn-outline-info btn-lg">
                  <i class="fas fa-search me-2"></i>Buscar más eventos
                </a>
              </div>
            </div>
          {% else %}
            <!-- User has no events at all -->
            <div class="empty-state no-events-state">
              <div class="fa-stack">
                <i class="fas fa-circle fa-stack-2x text-warning"></i>
                <i class="fas fa-calendar-alt fa-stack-1x fa-inverse"></i>
              </div>
              <h3 class="text-warning mb-3">Tu calendario está vacío</h3>
              <p class="text-muted mb-4">¡Registrate en eventos para verlos organizados en tu calendario personal!</p>
              <a href="{% url 'events:list' %}" class="btn btn-warning btn-lg">
                <i class="fas fa-search me-2"></i>Explorar Eventos
              </a>
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
      <nav aria-label="Paginación de mis eventos" class="mt-4">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page=1">
                <i class="fas fa-angle-double-left"></i>
              </a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
                <i class="fas fa-angle-left"></i>
              </a>
            </li>
          {% endif %}
          
          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active">
                <span class="page-link">{{ num }}</span>
              </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}
          
          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                <i class="fas fa-angle-right"></i>
              </a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">
                <i class="fas fa-angle-double-right"></i>
              </a>
            </li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}

  {% else %}
    <!-- No Events -->
    <div class="text-center py-5">
      {% if has_any_events %}
        <!-- User has events but current filters don't show any -->
        <div class="empty-state no-filtered-events-state">
          <div class="fa-stack">
            <i class="fas fa-circle fa-stack-2x text-info"></i>
            <i class="fas fa-search fa-stack-1x fa-inverse"></i>
          </div>
          <h3 class="text-info mb-3">No se encontraron eventos con los filtros actuales</h3>
          <p class="text-muted mb-4">
            Tienes eventos registrados, pero no coinciden con los filtros aplicados.
            <br>
            <small class="text-muted">Prueba con diferentes criterios de búsqueda o limpia los filtros.</small>
          </p>
          <div class="d-flex justify-content-center gap-3 flex-wrap">
            <a href="{% url 'events:my_events' %}" class="btn btn-info btn-lg">
              <i class="fas fa-times me-2"></i>Ver todos mis eventos
            </a>
            <a href="{% url 'events:list' %}" class="btn btn-outline-info btn-lg">
              <i class="fas fa-search me-2"></i>Buscar más eventos
            </a>
          </div>
        </div>
      {% else %}
        <!-- User has no events at all -->
        <div class="empty-state no-events-state">
          <div class="fa-stack">
            <i class="fas fa-circle fa-stack-2x text-warning"></i>
            <i class="fas fa-ticket-alt fa-stack-1x fa-inverse"></i>
          </div>
          <h3 class="text-warning mb-3">No tienes eventos registrados</h3>
          <p class="text-muted mb-4">¡Explora nuestra plataforma y encuentra eventos increíbles cerca de ti!</p>
          <a href="{% url 'events:list' %}" class="btn btn-warning btn-lg">
            <i class="fas fa-search me-2"></i>Explorar Eventos
          </a>
        </div>
      {% endif %}
    </div>
  {% endif %}
</div>

<!-- Ticket Download Modal -->
<div class="modal fade" id="ticketModal" tabindex="-1" aria-labelledby="ticketModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ticketModalLabel">
          <i class="fas fa-ticket-alt me-2"></i>Descargar Ticket
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
        <p>Tu ticket será descargado como archivo PDF.</p>
        <p class="text-muted">Presenta este ticket en el evento para el acceso.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="confirmDownload()">
          <i class="fas fa-download me-1"></i>Descargar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Event Detail Modal for Calendar -->
<div class="modal fade" id="eventDetailModal" tabindex="-1" aria-labelledby="eventDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="eventDetailModalLabel">
          <i class="fas fa-calendar-alt me-2"></i>Detalles del Evento
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="eventDetailContent">
        <!-- Event details will be populated by JavaScript -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <a href="#" id="viewEventBtn" class="btn btn-primary">Ver Evento Completo</a>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block modal %}
  {{ block.super }}
{% endblock modal %}

{% block inline_javascript %}
<style>
  /* Calendar Styles */
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background-color: #dee2e6;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    overflow: hidden;
  }

  .calendar-header {
    background-color: #f8f9fa;
    padding: 0.75rem 0.5rem;
    text-align: center;
    font-weight: 600;
    font-size: 0.875rem;
    color: #495057;
    border-bottom: 1px solid #dee2e6;
  }

  .calendar-day {
    background-color: #fff;
    min-height: 120px;
    padding: 0.5rem;
    position: relative;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .calendar-day:hover {
    background-color: #f8f9fa;
  }

  .calendar-day.other-month {
    background-color: #f8f9fa;
    color: #adb5bd;
  }

  .calendar-day.today {
    background-color: #e3f2fd;
    border: 2px solid #1976d2;
  }

  .calendar-day.has-events {
    background-color: #fff3cd;
  }

  .calendar-day-number {
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
  }

  .calendar-event {
    background-color: #0d6efd;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    margin-bottom: 0.25rem;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .calendar-event:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .calendar-event.confirmed {
    background-color: #198754;
  }

  .calendar-event.pending {
    background-color: #fd7e14;
  }

  .calendar-event.cancelled {
    background-color: #6c757d;
  }

  .calendar-event.finished {
    background-color: #adb5bd;
    color: #495057;
  }

  .calendar-event.today {
    background-color: #dc3545 !important;
    animation: pulse 2s infinite;
    border: 2px solid #fff;
    box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
  }

  .calendar-event.finished {
    background-color: #6c757d !important;
    color: #ffffff !important;
    opacity: 0.8;
    text-decoration: line-through;
  }

  @keyframes pulse {
    0% { 
      transform: scale(1);
      box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
    }
    50% { 
      transform: scale(1.02);
      box-shadow: 0 0 15px rgba(220, 53, 69, 0.8);
    }
    100% { 
      transform: scale(1);
      box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
    }
  }

  .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
  }

  .event-image-mini {
    width: 60px;
    height: 60px;
    overflow: hidden;
  }

  .event-image-mini img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .event-image-mini div {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
  }

  /* Week view styles */
  .calendar-week-view {
    display: grid;
    grid-template-columns: 100px repeat(7, 1fr);
    gap: 1px;
    background-color: #dee2e6;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    overflow: hidden;
  }

  .calendar-time-slot {
    background-color: #f8f9fa;
    padding: 0.5rem;
    text-align: center;
    font-size: 0.75rem;
    color: #6c757d;
    border-right: 1px solid #dee2e6;
  }

  .calendar-week-day {
    background-color: #fff;
    min-height: 60px;
    padding: 0.25rem;
    position: relative;
  }

  .calendar-week-event {
    background-color: #0d6efd;
    color: white;
    padding: 0.125rem 0.25rem;
    border-radius: 0.125rem;
    margin-bottom: 0.125rem;
    font-size: 0.625rem;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .calendar-day {
      min-height: 80px;
      padding: 0.25rem;
    }
    
    .calendar-event {
      font-size: 0.625rem;
      padding: 0.125rem 0.25rem;
    }
    
    .calendar-day-number {
      font-size: 0.75rem;
    }
  }

  /* Animation for view transitions */
  .view-transition {
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s ease;
  }

  .view-transition.active {
    opacity: 1;
    transform: translateY(0);
  }

  .event-card {
    animation: fadeInUp 0.3s ease forwards;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Event Detail Modal Styles */
  .event-details .d-flex {
    transition: all 0.2s ease;
  }

  .event-details .d-flex:hover {
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    padding: 0.25rem;
    margin: -0.25rem;
  }

  .event-item {
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .event-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  /* Professional Status Indicators */
  .badge {
    font-weight: 500;
    font-size: 0.75rem;
    padding: 0.35rem 0.65rem;
    border-radius: 0.375rem;
  }

  .badge i {
    font-size: 0.7rem;
  }

  /* Event status specific styles */
  .badge.bg-success {
    background-color: #198754 !important;
    box-shadow: 0 2px 4px rgba(25, 135, 84, 0.2);
  }

  .badge.bg-warning {
    background-color: #ffc107 !important;
    box-shadow: 0 2px 4px rgba(255, 193, 7, 0.2);
  }

  .badge.bg-secondary {
    background-color: #6c757d !important;
    box-shadow: 0 2px 4px rgba(108, 117, 125, 0.2);
  }

  .badge.bg-danger {
    background-color: #dc3545 !important;
    box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    animation: subtle-pulse 2s infinite;
  }

  .badge.bg-info {
    background-color: #0dcaf0 !important;
    color: #000 !important;
    box-shadow: 0 2px 4px rgba(13, 202, 240, 0.2);
  }

  .badge.bg-dark {
    background-color: #212529 !important;
    box-shadow: 0 2px 4px rgba(33, 37, 41, 0.2);
  }

  @keyframes subtle-pulse {
    0%, 100% { 
      transform: scale(1);
      box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    }
    50% { 
      transform: scale(1.02);
      box-shadow: 0 3px 6px rgba(220, 53, 69, 0.4);
    }
  }

  /* Status section improvements */
  .text-warning-emphasis {
    color: #cc8c00 !important;
  }

  /* Card enhancements */
  .event-card {
    transition: all 0.3s ease;
  }

  .event-card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.08) !important;
    transform: translateY(-2px);
  }

  /* Empty state styling */
  .empty-state {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 1rem;
    padding: 3rem 2rem;
    margin: 2rem 0;
    border: 2px dashed #dee2e6;
    transition: all 0.3s ease;
  }

  .empty-state:hover {
    border-color: #0d6efd;
    background: linear-gradient(135deg, #f0f7ff 0%, #ffffff 100%);
  }

  .empty-state .fa-stack {
    font-size: 3rem;
    margin-bottom: 1.5rem;
  }

  .empty-state h3 {
    color: #495057;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .empty-state p {
    color: #6c757d;
    font-size: 1.1rem;
    line-height: 1.6;
  }

  .empty-state small {
    color: #adb5bd;
    font-size: 0.9rem;
  }

  /* Differentiate no-events vs no-filtered-events */
  .no-events-state {
    border-color: #ffc107;
    background: linear-gradient(135deg, #fff8e1 0%, #ffffff 100%);
  }

  .no-events-state:hover {
    border-color: #ff9800;
    background: linear-gradient(135deg, #fff3c4 0%, #ffffff 100%);
  }

  .no-filtered-events-state {
    border-color: #17a2b8;
    background: linear-gradient(135deg, #e1f7fa 0%, #ffffff 100%);
  }

  .no-filtered-events-state:hover {
    border-color: #138496;
    background: linear-gradient(135deg, #bee5eb 0%, #ffffff 100%);
  }

  .day-events .events-list::-webkit-scrollbar {
    width: 6px;
  }

  .day-events .events-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
  }

  .day-events .events-list::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
  }

  .day-events .events-list::-webkit-scrollbar-thumb:hover {
    background: #555;
  }

  /* Status badges with icons */
  .badge i {
    margin-right: 0.25rem;
  }

  /* Click indicator for calendar events */
  .calendar-event {
    position: relative;
  }

  .calendar-event::after {
    content: '';
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 8px;
    height: 8px;
    background-color: rgba(255, 255, 255, 0.7);
    border-radius: 50%;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .calendar-event:hover::after {
    opacity: 1;
  }
</style>

<script>
  let currentTicketNumber = '';
  let currentDate = new Date();
  let calendarViewType = 'month';
  let eventsData = [];

  // Parse events data from Django template
  {% if tickets %}
    eventsData = [
      {% for ticket in tickets %}
        {
          id: {{ ticket.id }},
          title: "{{ ticket.event.title|escapejs }}",
          start: "{{ ticket.event.start_date|date:'Y-m-d H:i' }}",
          end: "{{ ticket.event.end_date|date:'Y-m-d H:i'|default:'' }}",
          status: "{{ ticket.status }}",
          ticketNumber: "{{ ticket.ticket_number }}",
          city: "{{ ticket.event.city.name|escapejs }}",
          venue: "{{ ticket.event.venue_name|escapejs }}",
          currency: "{{ ticket.event.currency }}",
          amountPaid: {{ ticket.amount_paid }},
          url: "{{ ticket.event.get_absolute_url }}",
          image: "{% if ticket.event.image %}{{ ticket.event.image.url }}{% endif %}",
          description: "{{ ticket.event.description|truncatechars:100|escapejs }}"
        }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];
  {% endif %}

  function downloadTicket(ticketNumber) {
    currentTicketNumber = ticketNumber;
    const modal = new bootstrap.Modal(document.getElementById('ticketModal'));
    modal.show();
  }

  function confirmDownload() {
    alert(`Descargando ticket #${currentTicketNumber}`);
    const modal = bootstrap.Modal.getInstance(document.getElementById('ticketModal'));
    modal.hide();
  }

  // View switching functionality
  function switchView(viewType) {
    const listView = document.getElementById('list-view');
    const calendarView = document.getElementById('calendar-view');
    
    if (viewType === 'calendar') {
      listView.style.display = 'none';
      calendarView.style.display = 'block';
      calendarView.classList.add('view-transition', 'active');
      generateCalendar();
      
      // Update pagination visibility
      const pagination = document.querySelector('nav[aria-label="Paginación de mis eventos"]');
      if (pagination) pagination.style.display = 'none';
    } else {
      calendarView.style.display = 'none';
      listView.style.display = 'block';
      listView.classList.add('view-transition', 'active');
      
      // Show pagination again
      const pagination = document.querySelector('nav[aria-label="Paginación de mis eventos"]');
      if (pagination) pagination.style.display = 'block';
    }
  }

  // Calendar generation
  function generateCalendar() {
    const calendarGrid = document.getElementById('calendar-grid');
    const currentMonthElement = document.getElementById('currentMonth');
    
    if (calendarViewType === 'month') {
      generateMonthView();
    } else {
      generateWeekView();
    }
    
    updateCurrentMonthDisplay();
  }

  function generateMonthView() {
    const calendarGrid = document.getElementById('calendar-grid');
    calendarGrid.innerHTML = '';
    calendarGrid.className = 'calendar-grid';
    
    // Add day headers
    const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
    dayHeaders.forEach(day => {
      const header = document.createElement('div');
      header.className = 'calendar-header';
      header.textContent = day;
      calendarGrid.appendChild(header);
    });
    
    // Get first day of month and number of days
    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    // Generate calendar days
    const today = new Date();
    for (let i = 0; i < 42; i++) { // 6 weeks * 7 days
      const cellDate = new Date(startDate);
      cellDate.setDate(startDate.getDate() + i);
      
      const dayElement = document.createElement('div');
      dayElement.className = 'calendar-day';
      
      if (cellDate.getMonth() !== currentDate.getMonth()) {
        dayElement.classList.add('other-month');
      }
      
      if (cellDate.toDateString() === today.toDateString()) {
        dayElement.classList.add('today');
      }
      
      // Add day number
      const dayNumber = document.createElement('div');
      dayNumber.className = 'calendar-day-number';
      dayNumber.textContent = cellDate.getDate();
      dayElement.appendChild(dayNumber);
      
      // Add events for this day
      const dayEvents = getEventsForDate(cellDate);
      if (dayEvents.length > 0) {
        dayElement.classList.add('has-events');
        dayEvents.forEach((event, index) => {
          if (index < 3) { // Show max 3 events per day
            const eventElement = createEventElement(event);
            dayElement.appendChild(eventElement);
          } else if (index === 3) {
            const moreElement = document.createElement('div');
            moreElement.className = 'calendar-event';
            moreElement.style.backgroundColor = '#6c757d';
            moreElement.textContent = `+${dayEvents.length - 3} más`;
            moreElement.onclick = (e) => {
              e.stopPropagation();
              showDayEvents(cellDate, dayEvents);
            };
            dayElement.appendChild(moreElement);
          }
        });
      }
      
      calendarGrid.appendChild(dayElement);
    }
  }

  function generateWeekView() {
    const calendarGrid = document.getElementById('calendar-grid');
    calendarGrid.innerHTML = '';
    calendarGrid.className = 'calendar-week-view';
    
    // Get week start (Sunday)
    const weekStart = new Date(currentDate);
    weekStart.setDate(currentDate.getDate() - currentDate.getDay());
    
    // Add empty cell for time column
    const emptyCell = document.createElement('div');
    emptyCell.className = 'calendar-time-slot';
    calendarGrid.appendChild(emptyCell);
    
    // Add day headers
    const dayHeaders = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
    for (let i = 0; i < 7; i++) {
      const dayDate = new Date(weekStart);
      dayDate.setDate(weekStart.getDate() + i);
      
      const header = document.createElement('div');
      header.className = 'calendar-header';
      header.innerHTML = `<div>${dayHeaders[i]}</div><div>${dayDate.getDate()}</div>`;
      calendarGrid.appendChild(header);
    }
    
    // Add time slots (24 hours)
    for (let hour = 0; hour < 24; hour++) {
      // Time label
      const timeSlot = document.createElement('div');
      timeSlot.className = 'calendar-time-slot';
      timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
      calendarGrid.appendChild(timeSlot);
      
      // Day cells for this hour
      for (let day = 0; day < 7; day++) {
        const cellDate = new Date(weekStart);
        cellDate.setDate(weekStart.getDate() + day);
        cellDate.setHours(hour, 0, 0, 0);
        
        const dayCell = document.createElement('div');
        dayCell.className = 'calendar-week-day';
        
        // Add events for this hour
        const hourEvents = getEventsForDateHour(cellDate);
        hourEvents.forEach(event => {
          const eventElement = createWeekEventElement(event);
          dayCell.appendChild(eventElement);
        });
        
        calendarGrid.appendChild(dayCell);
      }
    }
  }

  function getEventsForDate(date) {
    return eventsData.filter(event => {
      const eventDate = new Date(event.start);
      return eventDate.toDateString() === date.toDateString();
    });
  }

  function getEventsForDateHour(date) {
    return eventsData.filter(event => {
      const eventDate = new Date(event.start);
      return eventDate.toDateString() === date.toDateString() && 
             eventDate.getHours() === date.getHours();
    });
  }

  function createEventElement(event) {
    const eventElement = document.createElement('div');
    eventElement.className = 'calendar-event';
    eventElement.textContent = event.title;
    
    const eventDate = new Date(event.start);
    const today = new Date();
    const isToday = eventDate.toDateString() === today.toDateString();
    const isFinished = eventDate < today;
    
    // Set color based on status and time
    if (isToday) {
      eventElement.classList.add('today');
      eventElement.style.backgroundColor = '#dc3545'; // Red for today's events
    } else if (isFinished) {
      eventElement.classList.add('finished');
      eventElement.style.backgroundColor = '#6c757d'; // Gray for finished events
      eventElement.style.color = '#ffffff';
    } else {
      // Apply status-based colors for future events
      const statusClasses = {
        'confirmed': 'confirmed',
        'pending': 'pending',
        'cancelled': 'cancelled'
      };
      
      if (statusClasses[event.status]) {
        eventElement.classList.add(statusClasses[event.status]);
      }
    }
    
    // Add click handler to redirect to event page
    eventElement.onclick = (e) => {
      e.stopPropagation();
      window.location.href = event.url;
    };
    
    // Add tooltip with event time
    eventElement.title = `${event.title} - ${eventDate.toLocaleTimeString('es-ES', { 
      hour: '2-digit', 
      minute: '2-digit' 
    })}`;
    
    return eventElement;
  }

  function createWeekEventElement(event) {
    const eventElement = document.createElement('div');
    eventElement.className = 'calendar-week-event';
    eventElement.textContent = event.title;
    
    const eventDate = new Date(event.start);
    const today = new Date();
    const isToday = eventDate.toDateString() === today.toDateString();
    const isFinished = eventDate < today;
    
    // Set color based on status and time
    if (isToday) {
      eventElement.style.backgroundColor = '#dc3545'; // Red for today's events
      eventElement.classList.add('today');
    } else if (isFinished) {
      eventElement.style.backgroundColor = '#6c757d'; // Gray for finished events
      eventElement.style.color = '#ffffff';
      eventElement.classList.add('finished');
    } else {
      // Apply status-based colors for future events
      const statusClasses = {
        'confirmed': 'confirmed',
        'pending': 'pending',
        'cancelled': 'cancelled'
      };
      
      if (statusClasses[event.status]) {
        eventElement.classList.add(statusClasses[event.status]);
      }
    }
    
    // Add click handler to redirect to event page
    eventElement.onclick = (e) => {
      e.stopPropagation();
      window.location.href = event.url;
    };
    
    // Add tooltip with event time
    eventElement.title = `${event.title} - ${eventDate.toLocaleTimeString('es-ES', { 
      hour: '2-digit', 
      minute: '2-digit' 
    })}`;
    
    return eventElement;
  }

  function showEventDetail(event) {
    const modal = new bootstrap.Modal(document.getElementById('eventDetailModal'));
    const content = document.getElementById('eventDetailContent');
    const viewBtn = document.getElementById('viewEventBtn');
    
    const eventDate = new Date(event.start);
    const now = new Date();
    const isToday = eventDate.toDateString() === now.toDateString();
    const isFinished = eventDate < now;
    
    // Status badge
    let statusBadge = '';
    switch(event.status) {
      case 'confirmed':
        statusBadge = '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Confirmado</span>';
        break;
      case 'pending':
        statusBadge = '<span class="badge bg-warning"><i class="fas fa-clock me-1"></i>Pendiente</span>';
        break;
      case 'cancelled':
        statusBadge = '<span class="badge bg-secondary"><i class="fas fa-times-circle me-1"></i>Cancelado</span>';
        break;
    }
    
    // Time status badge
    let timeStatus = '';
    if (isFinished) {
      timeStatus = '<span class="badge bg-secondary"><i class="fas fa-flag-checkered me-1"></i>FINALIZADO</span>';
    } else if (isToday) {
      timeStatus = '<span class="badge bg-danger"><i class="fas fa-calendar-day me-1"></i>HOY</span>';
    } else {
      const daysUntil = Math.ceil((eventDate - now) / (1000 * 60 * 60 * 24));
      timeStatus = `<span class="badge bg-info"><i class="fas fa-calendar-plus me-1"></i>En ${daysUntil} día${daysUntil !== 1 ? 's' : ''}</span>`;
    }
    
    // Format event date
    const formattedDate = eventDate.toLocaleDateString('es-ES', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    content.innerHTML = `
      <div class="row">
        <div class="col-md-4">
          ${event.image ? 
            `<img src="${event.image}" alt="${event.title}" class="img-fluid rounded shadow-sm">` :
            `<img src="{{ MEDIA_URL }}events/default/general_event.png" alt="${event.title}" class="img-fluid rounded shadow-sm">`
          }
        </div>
        <div class="col-md-8">
          <h4 class="mb-3 text-primary">${event.title}</h4>
          
          <!-- Status Badges -->
          <div class="mb-3 d-flex gap-2 flex-wrap">
            ${statusBadge}
            ${timeStatus}
          </div>
          
          <!-- Event Details -->
          <div class="event-details">
            <div class="mb-2 d-flex align-items-center">
              <i class="fas fa-calendar-alt me-2 text-primary" style="width: 20px;"></i>
              <strong class="me-2">Fecha:</strong> 
              <span>${formattedDate}</span>
            </div>
            
            <div class="mb-2 d-flex align-items-center">
              <i class="fas fa-map-marker-alt me-2 text-danger" style="width: 20px;"></i>
              <strong class="me-2">Ubicación:</strong> 
              <span>${event.city}${event.venue ? ` - ${event.venue}` : ''}</span>
            </div>
            
            <div class="mb-2 d-flex align-items-center">
              <i class="fas fa-ticket-alt me-2 text-success" style="width: 20px;"></i>
              <strong class="me-2">Ticket:</strong> 
              <span class="font-monospace">#${event.ticketNumber}</span>
            </div>
            
            <div class="mb-3 d-flex align-items-center">
              <i class="fas fa-dollar-sign me-2 text-warning" style="width: 20px;"></i>
              <strong class="me-2">Precio:</strong> 
              ${event.amountPaid === 0 ? 
                '<span class="text-success fw-bold"><i class="fas fa-gift me-1"></i>GRATIS</span>' : 
                `<span class="fw-bold text-primary">${event.currency} ${event.amountPaid}</span>`
              }
            </div>
          </div>
          
          ${event.description ? `
            <div class="mb-3">
              <strong>Descripción:</strong>
              <p class="text-muted mt-1">${event.description}</p>
            </div>
          ` : ''}
          
          <!-- Action Buttons -->
          <div class="d-flex gap-2 mt-3 flex-wrap">
            ${event.status === 'confirmed' ? 
              `<button class="btn btn-outline-success btn-sm" onclick="downloadTicket('${event.ticketNumber}')" title="Descargar ticket">
                <i class="fas fa-download me-1"></i>Descargar Ticket
              </button>` : ''
            }
            <button class="btn btn-outline-info btn-sm" onclick="shareEvent('${event.title}', '${event.url}')" title="Compartir evento">
              <i class="fas fa-share-alt me-1"></i>Compartir
            </button>
            ${isToday ? 
              `<button class="btn btn-warning btn-sm" title="¡El evento es hoy!">
                <i class="fas fa-exclamation-triangle me-1"></i>Evento Hoy
              </button>` : ''
            }
          </div>
        </div>
      </div>
    `;
    
    viewBtn.href = event.url;
    modal.show();
  }

  function showDayEvents(date, events) {
    const modal = new bootstrap.Modal(document.getElementById('eventDetailModal'));
    const content = document.getElementById('eventDetailContent');
    const viewBtn = document.getElementById('viewEventBtn');
    
    const dateString = date.toLocaleDateString('es-ES', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric'
    });
    
    let eventsHtml = '';
    events.forEach((event, index) => {
      const eventDate = new Date(event.start);
      const now = new Date();
      const isToday = eventDate.toDateString() === now.toDateString();
      const isFinished = eventDate < now;
      
      let statusBadge = '';
      switch(event.status) {
        case 'confirmed':
          statusBadge = '<span class="badge bg-success">Confirmado</span>';
          break;
        case 'pending':
          statusBadge = '<span class="badge bg-warning">Pendiente</span>';
          break;
        case 'cancelled':
          statusBadge = '<span class="badge bg-secondary">Cancelado</span>';
          break;
      }
      
      let timeStatus = '';
      if (isFinished) {
        timeStatus = '<span class="badge bg-secondary">FINALIZADO</span>';
      } else if (isToday) {
        timeStatus = '<span class="badge bg-danger">HOY</span>';
      }
      
      eventsHtml += `
        <div class="event-item p-3 border rounded mb-3 ${index % 2 === 0 ? 'bg-light' : ''}">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <h6 class="mb-2">
                <a href="${event.url}" class="text-decoration-none text-primary">${event.title}</a>
              </h6>
              <div class="mb-2">
                ${statusBadge} ${timeStatus}
              </div>
              <div class="text-muted small">
                <i class="fas fa-clock me-1"></i>
                ${eventDate.toLocaleTimeString('es-ES', { 
                  hour: '2-digit', 
                  minute: '2-digit' 
                })}
                <span class="mx-2">|</span>
                <i class="fas fa-map-marker-alt me-1"></i>
                ${event.city}
                <span class="mx-2">|</span>
                <i class="fas fa-ticket-alt me-1"></i>
                #${event.ticketNumber}
              </div>
            </div>
            <div class="d-flex gap-1">
              <button class="btn btn-outline-primary btn-sm" onclick="showEventDetail(eventsData.find(e => e.id === ${event.id}))" title="Ver detalles">
                <i class="fas fa-eye"></i>
              </button>
              ${event.status === 'confirmed' ? 
                `<button class="btn btn-outline-success btn-sm" onclick="downloadTicket('${event.ticketNumber}')" title="Descargar ticket">
                  <i class="fas fa-download"></i>
                </button>` : ''
              }
            </div>
          </div>
        </div>
      `;
    });
    
    content.innerHTML = `
      <div class="day-events">
        <div class="mb-3 text-center">
          <h5 class="text-primary">
            <i class="fas fa-calendar-day me-2"></i>
            Eventos del ${dateString}
          </h5>
          <p class="text-muted mb-0">${events.length} evento${events.length !== 1 ? 's' : ''} programado${events.length !== 1 ? 's' : ''}</p>
        </div>
        <div class="events-list" style="max-height: 400px; overflow-y: auto;">
          ${eventsHtml}
        </div>
      </div>
    `;
    
    viewBtn.style.display = 'none'; // Hide the "Ver Evento Completo" button for day view
    modal.show();
    
    // Restore the button when modal is hidden
    document.getElementById('eventDetailModal').addEventListener('hidden.bs.modal', function() {
      viewBtn.style.display = 'inline-block';
    }, { once: true });
  }

  function shareEvent(title, url) {
    if (navigator.share) {
      navigator.share({
        title: title,
        text: `¡Mira este evento increíble: ${title}!`,
        url: url
      }).then(() => {
        console.log('Evento compartido exitosamente');
      }).catch((error) => {
        console.log('Error al compartir:', error);
        fallbackShare(title, url);
      });
    } else {
      fallbackShare(title, url);
    }
  }

  function fallbackShare(title, url) {
    const text = `¡Mira este evento increíble: ${title}! ${url}`;
    
    if (navigator.clipboard) {
      navigator.clipboard.writeText(text).then(() => {
        alert('¡Enlace copiado al portapapeles! Puedes pegarlo donde quieras compartirlo.');
      }).catch(() => {
        showShareModal(text);
      });
    } else {
      showShareModal(text);
    }
  }

  function showShareModal(text) {
    const existingModal = document.getElementById('shareModal');
    if (existingModal) {
      existingModal.remove();
    }
    
    const shareModalHTML = `
      <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">
                <i class="fas fa-share-alt me-2"></i>Compartir Evento
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <p>Copia este texto para compartir el evento:</p>
              <div class="form-group">
                <textarea class="form-control" rows="3" readonly>${text}</textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
              <button type="button" class="btn btn-primary" onclick="copyToClipboard('${text.replace(/'/g, "\\'")}')">
                <i class="fas fa-copy me-1"></i>Copiar
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', shareModalHTML);
    const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
    shareModal.show();
  }

  function copyToClipboard(text) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('shareModal'));
    modal.hide();
    alert('¡Texto copiado al portapapeles!');
  }

  function updateCurrentMonthDisplay() {
    const currentMonthElement = document.getElementById('currentMonth');
    const monthNames = [
      'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
    ];
    
    if (calendarViewType === 'month') {
      currentMonthElement.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
    } else {
      const weekStart = new Date(currentDate);
      weekStart.setDate(currentDate.getDate() - currentDate.getDay());
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);
      
      currentMonthElement.textContent = 
        `${weekStart.getDate()} ${monthNames[weekStart.getMonth()]} - ${weekEnd.getDate()} ${monthNames[weekEnd.getMonth()]} ${currentDate.getFullYear()}`;
    }
  }

  // Calendar navigation
  function navigateCalendar(direction) {
    if (calendarViewType === 'month') {
      currentDate.setMonth(currentDate.getMonth() + direction);
    } else {
      currentDate.setDate(currentDate.getDate() + (direction * 7));
    }
    generateCalendar();
  }

  function goToToday() {
    currentDate = new Date();
    generateCalendar();
  }

  // Page Initialization
  document.addEventListener('DOMContentLoaded', function() {
    // View switching
    document.getElementById('listView').addEventListener('change', function() {
      if (this.checked) switchView('list');
    });
    
    document.getElementById('calendarView').addEventListener('change', function() {
      if (this.checked) switchView('calendar');
    });
    
    // Calendar view type switching
    document.getElementById('monthView').addEventListener('change', function() {
      if (this.checked) {
        calendarViewType = 'month';
        generateCalendar();
      }
    });
    
    document.getElementById('weekView').addEventListener('change', function() {
      if (this.checked) {
        calendarViewType = 'week';
        generateCalendar();
      }
    });
    
    // Calendar navigation
    document.getElementById('prevMonth').addEventListener('click', () => navigateCalendar(-1));
    document.getElementById('nextMonth').addEventListener('click', () => navigateCalendar(1));
    document.getElementById('todayBtn').addEventListener('click', goToToday);
    
    // Auto-submit filters
    const filterForm = document.querySelector('.filter-form');
    if (filterForm) {
      const filterInputs = filterForm.querySelectorAll('select, input[name="search"]');
      
      filterInputs.forEach(input => {
        if (input.type === 'text') {
          let timeout;
          input.addEventListener('input', function() {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
              filterForm.submit();
            }, 500);
          });
        } else {
          input.addEventListener('change', function() {
            filterForm.submit();
          });
        }
      });
    }
    
    // Add entrance animation to cards
    const cards = document.querySelectorAll('.event-card');
    cards.forEach((card, index) => {
      card.style.animationDelay = `${index * 0.1}s`;
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        const searchInput = document.querySelector('input[name="search"]');
        if (searchInput) searchInput.focus();
      }
      
      if (e.key === 'Escape') {
        const searchInput = document.querySelector('input[name="search"]');
        if (searchInput && searchInput.value) {
          searchInput.value = '';
          if (filterForm) filterForm.submit();
        }
      }
      
      // Calendar navigation shortcuts
      if (document.getElementById('calendar-view').style.display !== 'none') {
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          navigateCalendar(-1);
        } else if (e.key === 'ArrowRight') {
          e.preventDefault();
          navigateCalendar(1);
        } else if (e.key === 'Home') {
          e.preventDefault();
          goToToday();
        }
      }
    });
  });
</script>
{% endblock inline_javascript %}
