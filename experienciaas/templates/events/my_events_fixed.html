{% extends "base.html" %}
{% load static %}

{% block title %}Mis Eventos - Experienciaas{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center justify-content-between flex-wrap">
        <div class="mb-3 mb-md-0">
          <h1 class="h3 fw-bold mb-1">Mis Eventos</h1>
          <p class="text-muted mb-0">Gestiona tus eventos registrados</p>
        </div>
        <div class="d-flex gap-2">
          <!-- View Toggle -->
          <div class="btn-group" role="group" aria-label="Tipo de vista">
            <input type="radio" class="btn-check" name="viewType" id="listView" autocomplete="off" checked>
            <label class="btn btn-outline-secondary" for="listView">
              <i class="fas fa-list me-1"></i>Lista
            </label>
            
            <input type="radio" class="btn-check" name="viewType" id="calendarView" autocomplete="off">
            <label class="btn btn-outline-secondary" for="calendarView">
              <i class="fas fa-calendar-alt me-1"></i>Calendario
            </label>
          </div>
          
          <a href="{% url 'events:list' %}" class="btn btn-outline-primary">
            <i class="fas fa-plus me-1"></i>Buscar Eventos
          </a>
        </div>
      </div>
    </div>
  </div>

  {% if tickets %}
    <!-- Quick Stats -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card border-0 bg-light">
          <div class="card-body py-3">
            <div class="row text-center">
              <div class="col-6 col-md-3">
                <div class="d-flex flex-column">
                  <span class="h5 mb-0 text-primary fw-bold">{{ stats.total }}</span>
                  <small class="text-muted">Total</small>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="d-flex flex-column">
                  <span class="h5 mb-0 text-success fw-bold">{{ stats.confirmed }}</span>
                  <small class="text-muted">Confirmados</small>
                </div>
              </div>
              <div class="col-6 col-md-3 mt-2 mt-md-0">
                <div class="d-flex flex-column">
                  <span class="h5 mb-0 text-info fw-bold">{{ stats.upcoming }}</span>
                  <small class="text-muted">Próximos</small>
                </div>
              </div>
              <div class="col-6 col-md-3 mt-2 mt-md-0">
                <div class="d-flex flex-column">
                  <span class="h5 mb-0 text-warning fw-bold">{{ stats.pending }}</span>
                  <small class="text-muted">Pendientes</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters and Search (shown in both views) -->
    <div class="row mb-4" id="filters-section">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-body py-3">
            <form method="get" class="filter-form">
              <div class="row g-3 align-items-center">
                <div class="col-md-4">
                  <div class="input-group">
                    <span class="input-group-text bg-white border-end-0">
                      <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" name="search" class="form-control border-start-0" 
                           placeholder="Buscar por nombre del evento..." 
                           value="{{ current_search }}">
                  </div>
                </div>
                
                <div class="col-md-2">
                  <select name="status" class="form-select">
                    <option value="">Estado</option>
                    <option value="confirmed" {% if current_status_filter == 'confirmed' %}selected{% endif %}>Confirmado</option>
                    <option value="pending" {% if current_status_filter == 'pending' %}selected{% endif %}>Pendiente</option>
                    <option value="cancelled" {% if current_status_filter == 'cancelled' %}selected{% endif %}>Cancelado</option>
                  </select>
                </div>
                
                <div class="col-md-2">
                  <select name="time_filter" class="form-select">
                    <option value="">Período</option>
                    <option value="upcoming" {% if current_time_filter == 'upcoming' %}selected{% endif %}>Próximos</option>
                    <option value="past" {% if current_time_filter == 'past' %}selected{% endif %}>Pasados</option>
                    <option value="today" {% if current_time_filter == 'today' %}selected{% endif %}>Hoy</option>
                    <option value="this_week" {% if current_time_filter == 'this_week' %}selected{% endif %}>Esta semana</option>
                  </select>
                </div>
                
                <div class="col-md-2">
                  <select name="sort" class="form-select">
                    <option value="-created_at" {% if request.GET.sort == '-created_at' or not request.GET.sort %}selected{% endif %}>Más recientes</option>
                    <option value="event__start_date" {% if request.GET.sort == 'event__start_date' %}selected{% endif %}>Por fecha evento</option>
                    <option value="event__title" {% if request.GET.sort == 'event__title' %}selected{% endif %}>Por nombre</option>
                  </select>
                </div>
                
                <div class="col-md-2">
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary btn-sm">
                      <i class="fas fa-filter"></i>
                    </button>
                    <a href="{% url 'events:my_events' %}" class="btn btn-outline-secondary btn-sm">
                      <i class="fas fa-times"></i>
                    </a>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- View Info -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center">
        <span class="text-muted me-3">{{ tickets|length }} evento{{ tickets|length|pluralize }}</span>
        {% if current_search %}
          <span class="badge bg-primary me-2">Filtrado por: "{{ current_search }}"</span>
        {% endif %}
        {% if current_status_filter %}
          <span class="badge bg-secondary me-2">Estado: {{ current_status_filter|capfirst }}</span>
        {% endif %}
        {% if current_time_filter and current_time_filter != 'upcoming' %}
          <span class="badge bg-info">
            {% if current_time_filter == 'past' %}Pasados
            {% elif current_time_filter == 'today' %}Hoy
            {% elif current_time_filter == 'this_week' %}Esta semana
            {% endif %}
          </span>
        {% endif %}
      </div>
    </div>

    <!-- Events List View -->
    <div id="list-view">
      <!-- Events List -->
      <div id="events-container">
        {% if tickets %}
          {% for ticket in tickets %}
            <div class="card border-0 shadow-sm mb-3 event-card">
              <div class="card-body p-3">
                <div class="row align-items-center">
                  <!-- Event Image -->
                  <div class="col-auto">
                    <div class="event-image-mini">
                      {% if ticket.event.image %}
                        <img src="{{ ticket.event.image.url }}" alt="{{ ticket.event.title }}" class="rounded">
                      {% else %}
                        <img src="{{ MEDIA_URL }}events/default/general_event.png" alt="{{ ticket.event.title }}" class="rounded">
                      {% endif %}
                    </div>
                  </div>
                  
                  <!-- Event Info -->
                  <div class="col">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="d-flex align-items-start">
                          <div class="flex-grow-1">
                            <h6 class="mb-1 fw-semibold">
                              <a href="{{ ticket.event.get_absolute_url }}" class="text-decoration-none text-dark">
                                {{ ticket.event.title }}
                              </a>
                            </h6>
                            <div class="d-flex align-items-center text-muted small mb-1">
                              <i class="fas fa-calendar-alt me-1"></i>
                              <span>{{ ticket.event.start_date|date:"d M Y, H:i" }}</span>
                            </div>
                            <div class="d-flex align-items-center text-muted small">
                              <i class="fas fa-map-marker-alt me-1"></i>
                              <span>{{ ticket.event.city.name }}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <div class="col-md-3">
                        <div class="text-center text-md-start">
                          <!-- Estado de la compra/aplicación -->
                          <div class="mb-2">
                            <div class="d-flex align-items-center justify-content-center justify-content-md-start mb-1">
                              <i class="fas fa-ticket-alt me-1 text-muted" style="font-size: 0.8rem;"></i>
                              <small class="text-muted fw-medium">Estado del Ticket</small>
                            </div>
                            <span class="badge {% if ticket.status == 'confirmed' %}bg-success{% elif ticket.status == 'pending' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                              {% if ticket.status == 'confirmed' %}
                                <i class="fas fa-check-circle me-1"></i>{{ ticket.get_status_display }}
                              {% elif ticket.status == 'pending' %}
                                <i class="fas fa-clock me-1"></i>{{ ticket.get_status_display }}
                              {% else %}
                                <i class="fas fa-times-circle me-1"></i>{{ ticket.get_status_display }}
                              {% endif %}
                            </span>
                          </div>
                          
                          <!-- Información del ticket -->
                          <div class="small text-muted mb-1">
                            <strong>#{{ ticket.ticket_number }}</strong>
                          </div>
                          
                          <!-- Precio -->
                          <div class="fw-semibold {% if ticket.amount_paid == 0 %}text-success{% else %}text-primary{% endif %}">
                            {% if ticket.amount_paid == 0 %}
                              <i class="fas fa-gift me-1"></i>GRATIS
                            {% else %}
                              <i class="fas fa-tag me-1"></i>{{ ticket.event.currency }} {{ ticket.amount_paid }}
                            {% endif %}
                          </div>
                        </div>
                      </div>
                      
                      <div class="col-md-3">
                        <div class="d-flex justify-content-end gap-2">
                          <a href="{{ ticket.event.get_absolute_url }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye"></i>
                          </a>
                          {% if ticket.status == 'confirmed' %}
                            <a href="{% url 'events:ticket_detail' ticket.ticket_number %}" target="_blank" class="btn btn-outline-secondary btn-sm" title="Ver ticket y descargar QR">
                              <i class="fas fa-qrcode"></i>
                            </a>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Event Status Timeline -->
                <div class="mt-3 pt-3 border-top">
                  <div class="row align-items-center">
                    <div class="col-auto">
                      <div class="d-flex align-items-center">
                        <i class="fas fa-calendar-check me-2 text-muted" style="font-size: 0.9rem;"></i>
                        <small class="text-muted fw-medium">Estado del Evento:</small>
                      </div>
                    </div>
                    <div class="col">
                      {% now "Y-m-d H:i" as current_time %}
                      {% if ticket.event.start_date|date:"Y-m-d H:i" < current_time %}
                        <span class="badge bg-dark">
                          <i class="fas fa-flag-checkered me-1"></i>FINALIZADO
                        </span>
                        <small class="text-muted ms-2">
                          Evento terminado el {{ ticket.event.start_date|date:"d/m/Y" }}
                        </small>
                      {% elif ticket.event.start_date|date:"Y-m-d" == current_time|date:"Y-m-d" %}
                        <span class="badge bg-danger">
                          <i class="fas fa-calendar-day me-1"></i>HOY
                        </span>
                        <small class="text-danger fw-bold ms-2">
                          ¡El evento es hoy a las {{ ticket.event.start_date|date:"H:i" }}!
                        </small>
                      {% else %}
                        {% comment %} Calcular si es en los próximos 7 días {% endcomment %}
                        {% if ticket.event.start_date|timeuntil|slice:":1" == "0" or "día" in ticket.event.start_date|timeuntil and "7 día" not in ticket.event.start_date|timeuntil|slice:"3:" %}
                          <span class="badge bg-warning text-dark">
                            <i class="fas fa-clock me-1"></i>PRÓXIMO
                          </span>
                          <small class="text-warning-emphasis fw-medium ms-2">
                            Faltan {{ ticket.event.start_date|timeuntil }}
                          </small>
                        {% else %}
                          <span class="badge bg-info">
                            <i class="fas fa-calendar-plus me-1"></i>PROGRAMADO
                          </span>
                          <small class="text-info ms-2">
                            En {{ ticket.event.start_date|timeuntil }}
                          </small>
                        {% endif %}
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <!-- No events message -->
          <div class="text-center py-5">
            {% if has_any_events %}
              <!-- User has events but filters don't match -->
              <div class="empty-state no-filtered-events-state">
                <div class="fa-stack">
                  <i class="fas fa-circle fa-stack-2x text-info"></i>
                  <i class="fas fa-filter fa-stack-1x fa-inverse"></i>
                </div>
                <h5 class="text-info mb-3">No se encontraron eventos</h5>
                <p class="text-muted mb-3">
                  No hay eventos que coincidan con los filtros aplicados.
                  <br>
                  <small>Tienes eventos registrados, pero no cumplen con los criterios de búsqueda actuales.</small>
                </p>
                <div class="d-flex justify-content-center gap-2 flex-wrap">
                  <a href="{% url 'events:my_events' %}" class="btn btn-info">
                    <i class="fas fa-times me-2"></i>Limpiar filtros
                  </a>
                  <a href="{% url 'events:list' %}" class="btn btn-outline-info">
                    <i class="fas fa-plus me-2"></i>Buscar más eventos
                  </a>
                </div>
              </div>
            {% else %}
              <!-- User has no events at all -->
              <div class="empty-state no-events-state">
                <div class="fa-stack">
                  <i class="fas fa-circle fa-stack-2x text-warning"></i>
                  <i class="fas fa-calendar-plus fa-stack-1x fa-inverse"></i>
                </div>
                <h5 class="text-warning mb-3">No tienes eventos registrados</h5>
                <p class="text-muted mb-3">¡Explora nuestra plataforma y encuentra eventos increíbles cerca de ti!</p>
                <a href="{% url 'events:list' %}" class="btn btn-warning">
                  <i class="fas fa-plus me-2"></i>Explorar eventos
                </a>
              </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Calendar View -->
    <div id="calendar-view" style="display: none;">
      {% if tickets %}
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <!-- Calendar Header -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="d-flex align-items-center gap-3">
                <button id="prevMonth" class="btn btn-outline-secondary btn-sm">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <h5 id="currentMonth" class="mb-0 fw-bold"></h5>
                <button id="nextMonth" class="btn btn-outline-secondary btn-sm">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
              <div class="d-flex gap-2">
                <button id="todayBtn" class="btn btn-outline-primary btn-sm">Hoy</button>
                <div class="btn-group" role="group">
                  <input type="radio" class="btn-check" name="calendarViewType" id="monthView" autocomplete="off" checked>
                  <label class="btn btn-outline-secondary btn-sm" for="monthView">Mes</label>
                  
                  <input type="radio" class="btn-check" name="calendarViewType" id="weekView" autocomplete="off">
                  <label class="btn btn-outline-secondary btn-sm" for="weekView">Semana</label>
                </div>
              </div>
            </div>
            
            <!-- Calendar Grid -->
            <div id="calendar-container">
              <div id="calendar-grid" class="calendar-grid">
                <!-- Calendar will be generated by JavaScript -->
              </div>
            </div>
            
            <!-- Calendar Legend -->
            <div class="mt-3 pt-3 border-top">
              <div class="row">
                <div class="col-md-6">
                  <small class="text-muted fw-medium d-block mb-2">
                    <i class="fas fa-ticket-alt me-1"></i>Estado del Ticket:
                  </small>
                  <div class="d-flex flex-wrap gap-3">
                    <div class="d-flex align-items-center">
                      <div class="status-dot bg-success me-1"></div>
                      <small>Confirmado</small>
                    </div>
                    <div class="d-flex align-items-center">
                      <div class="status-dot bg-warning me-1"></div>
                      <small>Pendiente</small>
                    </div>
                    <div class="d-flex align-items-center">
                      <div class="status-dot bg-secondary me-1"></div>
                      <small>Cancelado</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-6 mt-2 mt-md-0">
                  <small class="text-muted fw-medium d-block mb-2">
                    <i class="fas fa-calendar-check me-1"></i>Estado del Evento:
                  </small>
                  <div class="d-flex flex-wrap gap-3">
                    <div class="d-flex align-items-center">
                      <div class="status-dot bg-danger me-1"></div>
                      <small>Hoy</small>
                    </div>
                    <div class="d-flex align-items-center">
                      <div class="status-dot bg-warning me-1"></div>
                      <small>Próximo</small>
                    </div>
                    <div class="d-flex align-items-center">
                      <div class="status-dot bg-info me-1"></div>
                      <small>Programado</small>
                    </div>
                    <div class="d-flex align-items-center">
                      <div class="status-dot bg-dark me-1"></div>
                      <small>Finalizado</small>
                    </div>
                  </div>
                </div>
              </div>
              <div class="text-center mt-3">
                <small class="text-muted">
                  <i class="fas fa-info-circle me-1"></i>
                  Haz clic en un evento para ir a su página de detalles
                </small>
              </div>
            </div>
          </div>
        </div>
      {% else %}
        <!-- No Events in Calendar -->
        <div class="text-center py-5">
          {% if has_any_events %}
            <!-- User has events but filters don't match -->
            <div class="empty-state no-filtered-events-state">
              <div class="fa-stack">
                <i class="fas fa-circle fa-stack-2x text-info"></i>
                <i class="fas fa-calendar-times fa-stack-1x fa-inverse"></i>
              </div>
              <h3 class="text-info mb-3">No hay eventos en el calendario</h3>
              <p class="text-muted mb-4">
                No se encontraron eventos que coincidan con los filtros aplicados.
                <br>
                <small class="text-muted">Tienes eventos registrados, pero no cumplen con los criterios actuales.</small>
              </p>
              <div class="d-flex justify-content-center gap-3 flex-wrap">
                <a href="{% url 'events:my_events' %}" class="btn btn-info btn-lg">
                  <i class="fas fa-list me-2"></i>Ver todos mis eventos
                </a>
                <a href="{% url 'events:list' %}" class="btn btn-outline-info btn-lg">
                  <i class="fas fa-search me-2"></i>Buscar más eventos
                </a>
              </div>
            </div>
          {% else %}
            <!-- User has no events at all -->
            <div class="empty-state no-events-state">
              <div class="fa-stack">
                <i class="fas fa-circle fa-stack-2x text-warning"></i>
                <i class="fas fa-calendar-alt fa-stack-1x fa-inverse"></i>
              </div>
              <h3 class="text-warning mb-3">Tu calendario está vacío</h3>
              <p class="text-muted mb-4">¡Registrate en eventos para verlos organizados en tu calendario personal!</p>
              <a href="{% url 'events:list' %}" class="btn btn-warning btn-lg">
                <i class="fas fa-search me-2"></i>Explorar Eventos
              </a>
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
      <nav aria-label="Paginación de mis eventos" class="mt-4">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page=1">
                <i class="fas fa-angle-double-left"></i>
              </a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
                <i class="fas fa-angle-left"></i>
              </a>
            </li>
          {% endif %}
          
          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active">
                <span class="page-link">{{ num }}</span>
              </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}
          
          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                <i class="fas fa-angle-right"></i>
              </a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">
                <i class="fas fa-angle-double-right"></i>
              </a>
            </li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}

  {% else %}
    <!-- No Events -->
    <div class="text-center py-5">
      {% if has_any_events %}
        <!-- User has events but current filters don't show any -->
        <div class="empty-state no-filtered-events-state">
          <div class="fa-stack">
            <i class="fas fa-circle fa-stack-2x text-info"></i>
            <i class="fas fa-search fa-stack-1x fa-inverse"></i>
          </div>
          <h3 class="text-info mb-3">No se encontraron eventos con los filtros actuales</h3>
          <p class="text-muted mb-4">
            Tienes eventos registrados, pero no coinciden con los filtros aplicados.
            <br>
            <small class="text-muted">Prueba con diferentes criterios de búsqueda o limpia los filtros.</small>
          </p>
          <div class="d-flex justify-content-center gap-3 flex-wrap">
            <a href="{% url 'events:my_events' %}" class="btn btn-info btn-lg">
              <i class="fas fa-times me-2"></i>Ver todos mis eventos
            </a>
            <a href="{% url 'events:list' %}" class="btn btn-outline-info btn-lg">
              <i class="fas fa-search me-2"></i>Buscar más eventos
            </a>
          </div>
        </div>
      {% else %}
        <!-- User has no events at all -->
        <div class="empty-state no-events-state">
          <div class="fa-stack">
            <i class="fas fa-circle fa-stack-2x text-warning"></i>
            <i class="fas fa-ticket-alt fa-stack-1x fa-inverse"></i>
          </div>
          <h3 class="text-warning mb-3">No tienes eventos registrados</h3>
          <p class="text-muted mb-4">¡Explora nuestra plataforma y encuentra eventos increíbles cerca de ti!</p>
          <a href="{% url 'events:list' %}" class="btn btn-warning btn-lg">
            <i class="fas fa-search me-2"></i>Explorar Eventos
          </a>
        </div>
      {% endif %}
    </div>
  {% endif %}
</div>

<!-- Event Detail Modal for Calendar -->
<div class="modal fade" id="eventDetailModal" tabindex="-1" aria-labelledby="eventDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="eventDetailModalLabel">
          <i class="fas fa-calendar-alt me-2"></i>Detalles del Evento
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="eventDetailContent">
        <!-- Event details will be populated by JavaScript -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <a href="#" id="viewEventBtn" class="btn btn-primary">Ver Evento Completo</a>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block modal %}
  {{ block.super }}
{% endblock modal %}

{% block inline_javascript %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<style>
  /* Calendar Styles */
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background-color: #dee2e6;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    overflow: hidden;
  }

  .calendar-header {
    background-color: #f8f9fa;
    padding: 0.75rem 0.5rem;
    text-align: center;
    font-weight: 600;
    font-size: 0.875rem;
    color: #495057;
    border-bottom: 1px solid #dee2e6;
  }

  .calendar-day {
    background-color: #fff;
    min-height: 120px;
    padding: 0.5rem;
    position: relative;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .calendar-day:hover {
    background-color: #f8f9fa;
  }

  .calendar-day.other-month {
    background-color: #f8f9fa;
    color: #adb5bd;
  }

  .calendar-day.today {
    background-color: #e3f2fd;
    border: 2px solid #1976d2;
  }

  .calendar-day.has-events {
    background-color: #fff3cd;
  }

  .calendar-day-number {
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
  }

  .calendar-event {
    background-color: #0d6efd;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    margin-bottom: 0.25rem;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .calendar-event:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .calendar-event.confirmed {
    background-color: #198754;
  }

  .calendar-event.pending {
    background-color: #fd7e14;
  }

  .calendar-event.cancelled {
    background-color: #6c757d;
  }

  .calendar-event.finished {
    background-color: #adb5bd;
    color: #495057;
  }

  .calendar-event.today {
    background-color: #dc3545 !important;
    animation: pulse 2s infinite;
    border: 2px solid #fff;
    box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
  }

  .calendar-event.finished {
    background-color: #6c757d !important;
    color: #ffffff !important;
    opacity: 0.8;
    text-decoration: line-through;
  }

  @keyframes pulse {
    0% { 
      transform: scale(1);
      box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
    }
    50% { 
      transform: scale(1.02);
      box-shadow: 0 0 15px rgba(220, 53, 69, 0.8);
    }
    100% { 
      transform: scale(1);
      box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
    }
  }

  .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
  }

  .event-image-mini {
    width: 60px;
    height: 60px;
    overflow: hidden;
  }

  .event-image-mini img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .event-image-mini div {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
  }

  /* Week view styles */
  .calendar-week-view {
    display: grid;
    grid-template-columns: 100px repeat(7, 1fr);
    gap: 1px;
    background-color: #dee2e6;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    overflow: hidden;
  }

  .calendar-time-slot {
    background-color: #f8f9fa;
    padding: 0.5rem;
    text-align: center;
    font-size: 0.75rem;
    color: #6c757d;
    border-right: 1px solid #dee2e6;
  }

  .calendar-week-day {
    background-color: #fff;
    min-height: 60px;
    padding: 0.25rem;
    position: relative;
  }

  .calendar-week-event {
    background-color: #0d6efd;
    color: white;
    padding: 0.125rem 0.25rem;
    border-radius: 0.125rem;
    margin-bottom: 0.125rem;
    font-size: 0.625rem;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .calendar-day {
      min-height: 80px;
      padding: 0.25rem;
    }
    
    .calendar-event {
      font-size: 0.625rem;
      padding: 0.125rem 0.25rem;
    }
    
    .calendar-day-number {
      font-size: 0.75rem;
    }
  }

  /* Animation for view transitions */
  .view-transition {
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s ease;
  }

  .view-transition.active {
    opacity: 1;
    transform: translateY(0);
  }

  .event-card {
    animation: fadeInUp 0.3s ease forwards;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Event Detail Modal Styles */
  .event-details .d-flex {
    transition: all 0.2s ease;
  }

  .event-details .d-flex:hover {
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    padding: 0.25rem;
    margin: -0.25rem;
  }

  .event-item {
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .event-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  /* Professional Status Indicators */
  .badge {
    font-weight: 500;
    font-size: 0.75rem;
    padding: 0.35rem 0.65rem;
    border-radius: 0.375rem;
  }

  .badge i {
    font-size: 0.7rem;
  }

  /* Event status specific styles */
  .badge.bg-success {
    background-color: #198754 !important;
    box-shadow: 0 2px 4px rgba(25, 135, 84, 0.2);
  }

  .badge.bg-warning {
    background-color: #ffc107 !important;
    box-shadow: 0 2px 4px rgba(255, 193, 7, 0.2);
  }

  .badge.bg-secondary {
    background-color: #6c757d !important;
    box-shadow: 0 2px 4px rgba(108, 117, 125, 0.2);
  }

  .badge.bg-danger {
    background-color: #dc3545 !important;
    box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    animation: subtle-pulse 2s infinite;
  }

  .badge.bg-info {
    background-color: #0dcaf0 !important;
    color: #000 !important;
    box-shadow: 0 2px 4px rgba(13, 202, 240, 0.2);
  }

  .badge.bg-dark {
    background-color: #212529 !important;
    box-shadow: 0 2px 4px rgba(33, 37, 41, 0.2);
  }

  @keyframes subtle-pulse {
    0%, 100% { 
      transform: scale(1);
      box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    }
    50% { 
      transform: scale(1.02);
      box-shadow: 0 3px 6px rgba(220, 53, 69, 0.4);
    }
  }

  /* Status section improvements */
  .text-warning-emphasis {
    color: #cc8c00 !important;
  }

  /* Card enhancements */
  .event-card {
    transition: all 0.3s ease;
  }

  .event-card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.08) !important;
    transform: translateY(-2px);
  }

  /* Empty state styling */
  .empty-state {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 1rem;
    padding: 3rem 2rem;
    margin: 2rem 0;
    border: 2px dashed #dee2e6;
    transition: all 0.3s ease;
  }

  .empty-state:hover {
    border-color: #0d6efd;
    background: linear-gradient(135deg, #f0f7ff 0%, #ffffff 100%);
  }

  .empty-state .fa-stack {
    font-size: 3rem;
    margin-bottom: 1.5rem;
  }

  .empty-state h3 {
    color: #495057;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .empty-state p {
    color: #6c757d;
    font-size: 1.1rem;
    line-height: 1.6;
  }

  .empty-state small {
    color: #adb5bd;
    font-size: 0.9rem;
  }

  /* Differentiate no-events vs no-filtered-events */
  .no-events-state {
    border-color: #ffc107;
    background: linear-gradient(135deg, #fff8e1 0%, #ffffff 100%);
  }

  .no-events-state:hover {
    border-color: #ff9800;
    background: linear-gradient(135deg, #fff3c4 0%, #ffffff 100%);
  }

  .no-filtered-events-state {
    border-color: #17a2b8;
    background: linear-gradient(135deg, #e1f7fa 0%, #ffffff 100%);
  }

  .no-filtered-events-state:hover {
    border-color: #138496;
    background: linear-gradient(135deg, #bee5eb 0%, #ffffff 100%);
  }

  .day-events .events-list::-webkit-scrollbar {
    width: 6px;
  }

  .day-events .events-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
  }

  .day-events .events-list::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
  }

  .day-events .events-list::-webkit-scrollbar-thumb:hover {
    background: #555;
  }

  /* Status badges with icons */
  .badge i {
    margin-right: 0.25rem;
  }

  /* Click indicator for calendar events */
  .calendar-event {
    position: relative;
  }

  .calendar-event::after {
    content: '';
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 8px;
    height: 8px;
    background-color: rgba(255, 255, 255, 0.7);
    border-radius: 50%;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .calendar-event:hover::after {
    opacity: 1;
  }
</style>

<!-- Simplificado: Solo FullCalendar, sin sistema QR -->
<script>
// Simplificado: Solo FullCalendar, sin sistema QR
let myCalendar;

document.addEventListener('DOMContentLoaded', function() {
    initializeCalendar();
});

function initializeCalendar() {
    console.log('Initializing calendar...');
    var calendarEl = document.getElementById('calendar');
    if (!calendarEl) return;

    const events = {{ events_json|safe }};
    
    // Transform events for FullCalendar
    const calendarEvents = events.map(event => {
        const startDate = new Date(event.start_date);
        const endDate = new Date(event.end_date);
        const ticketStatuses = event.tickets.map(t => t.status);
        const hasConfirmed = ticketStatuses.includes('confirmed');
        const hasPending = ticketStatuses.includes('pending');
        
        let borderColor = '#6c757d';
        let backgroundColor = '#f8f9fa';
        
        if (hasConfirmed) {
            borderColor = '#28a745';
            backgroundColor = '#d4edda';
        } else if (hasPending) {
            borderColor = '#ffc107';
            backgroundColor = '#fff3cd';
        }
        
        return {
            id: event.id,
            title: event.name,
            start: startDate.toISOString(),
            end: endDate.toISOString(),
            borderColor: borderColor,
            backgroundColor: backgroundColor,
            extendedProps: {
                location: event.location,
                description: event.description,
                price: event.price,
                image: event.image,
                is_free: event.is_free,
                tickets: event.tickets
            }
        };
    });
    
    myCalendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 'auto',
        locale: 'es',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,listMonth'
        },
        buttonText: {
            today: 'Hoy',
            month: 'Mes',
            list: 'Lista'
        },
        events: calendarEvents,
        eventClick: function(info) {
            showEventDetail(info.event);
        },
        dateClick: function(info) {
            showDayEvents(info.dateStr);
        }
    });
    
    myCalendar.render();
}

function showEventDetail(event) {
    const modal = new bootstrap.Modal(document.getElementById('eventDetailModal'));
    const modalTitle = document.getElementById('eventDetailModalLabel');
    const modalBody = document.getElementById('eventDetailContent');
    const viewBtn = document.getElementById('viewEventBtn');
    
    modalTitle.innerHTML = `<i class="fas fa-calendar-alt me-2"></i>${event.title}`;
    
    const tickets = event.extendedProps.tickets;
    let ticketsHtml = '';
    
    if (tickets && tickets.length > 0) {
        ticketsHtml = `
            <div class="mt-3">
                <h6><i class="fas fa-ticket-alt me-2"></i>Mis Tickets</h6>
                <div class="list-group">
        `;
        
        tickets.forEach(ticket => {
            const statusClass = getStatusClass(ticket.status);
            const statusText = getStatusText(ticket.status);
            
            ticketsHtml += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>Ticket #${ticket.ticket_number}</strong>
                        <small class="d-block text-muted">${ticket.purchase_date}</small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge ${statusClass}">${statusText}</span>
                    </div>
                </div>
            `;
        });
        
        ticketsHtml += `
                </div>
            </div>
        `;
    }
    
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <img src="${event.extendedProps.image || '/static/images/default-event.jpg'}" 
                     class="img-fluid rounded" alt="${event.title}">
            </div>
            <div class="col-md-8">
                <p><i class="fas fa-map-marker-alt me-2"></i>${event.extendedProps.location}</p>
                <p><i class="fas fa-calendar me-2"></i>${event.start.toLocaleDateString('es-ES')}</p>
                <p><i class="fas fa-clock me-2"></i>${event.start.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}</p>
                <p><i class="fas fa-euro-sign me-2"></i>${event.extendedProps.is_free ? 'Gratis' : event.extendedProps.price + '€'}</p>
                <p class="mt-3">${event.extendedProps.description}</p>
            </div>
        </div>
        ${ticketsHtml}
    `;
    
    viewBtn.href = `/events/${event.id}/`;
    modal.show();
}

function showDayEvents(dateStr) {
    const date = new Date(dateStr);
    const events = myCalendar.getEvents().filter(event => {
        const eventDate = new Date(event.start);
        return eventDate.toDateString() === date.toDateString();
    });
    
    if (events.length === 0) {
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('eventDetailModal'));
    const modalTitle = document.getElementById('eventDetailModalLabel');
    const modalBody = document.getElementById('eventDetailContent');
    const viewBtn = document.getElementById('viewEventBtn');
    
    modalTitle.innerHTML = `<i class="fas fa-calendar-day me-2"></i>Eventos del ${date.toLocaleDateString('es-ES')}`;
    
    let eventsHtml = '<div class="list-group">';
    
    events.forEach(event => {
        const tickets = event.extendedProps.tickets;
        let ticketsHtml = '';
        
        if (tickets && tickets.length > 0) {
            ticketsHtml = '<div class="mt-2">';
            tickets.forEach(ticket => {
                const statusClass = getStatusClass(ticket.status);
                const statusText = getStatusText(ticket.status);
                
                ticketsHtml += `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small>Ticket #${ticket.ticket_number}</small>
                        <span class="badge ${statusClass}">${statusText}</span>
                    </div>
                `;
            });
            ticketsHtml += '</div>';
        }
        
        eventsHtml += `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">${event.title}</h6>
                        <p class="mb-1 small text-muted">
                            <i class="fas fa-clock me-1"></i>${event.start.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})} - 
                            <i class="fas fa-map-marker-alt me-1"></i>${event.extendedProps.location}
                        </p>
                        <p class="mb-1 small">${event.extendedProps.description}</p>
                        ${ticketsHtml}
                    </div>
                    <span class="badge bg-primary">${event.extendedProps.is_free ? 'Gratis' : event.extendedProps.price + '€'}</span>
                </div>
            </div>
        `;
    });
    
    eventsHtml += '</div>';
    modalBody.innerHTML = eventsHtml;
    viewBtn.style.display = 'none';
    modal.show();
}

function getStatusClass(status) {
    switch(status) {
        case 'confirmed': return 'bg-success';
        case 'pending': return 'bg-warning';
        case 'cancelled': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function getStatusText(status) {
    switch(status) {
        case 'confirmed': return 'Confirmado';
        case 'pending': return 'Pendiente';
        case 'cancelled': return 'Cancelado';
        default: return 'Desconocido';
    }
}
</script>
{% endblock inline_javascript %}
