{% extends "base.html" %}

{% load static %}

{% block title %}
  Perfil de {{ object.name|default:object.email }} - Experienciaas
{% endblock title %}

{% block css %}
  {{ block.super }}
  <style>
    .profile-hero {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 3rem 0;
      margin-bottom: 2rem;
    }
    .profile-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      padding: 2rem;
      margin-top: -80px;
      position: relative;
      z-index: 2;
    }
    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(45deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      font-weight: 700;
      color: white;
      margin: 0 auto 1rem;
      border: 5px solid white;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .profile-actions .btn {
      border-radius: 12px;
      font-weight: 600;
      padding: 12px 25px;
      margin: 0.5rem;
      transition: all 0.3s ease;
    }
    .profile-actions .btn-primary {
      background: linear-gradient(45deg, #667eea, #764ba2);
      border: none;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    .profile-actions .btn-outline-secondary {
      border: 2px solid #6c757d;
      color: #6c757d;
    }
    .profile-actions .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .info-section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 1.5rem;
      margin: 1rem 0;
    }
    .info-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 0.5rem;
    }
    .info-value {
      color: #6c757d;
      font-size: 1.1rem;
    }
    .application-card {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .application-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    }
    .role-icon {
      transition: all 0.3s ease;
    }
    .card:hover .role-icon {
      transform: scale(1.1);
    }
    .benefits small {
      transition: all 0.2s ease;
    }
    .application-card:hover .benefits small {
      transform: translateX(5px);
    }
    .application-icon {
      transition: all 0.3s ease;
    }
    .application-card:hover .application-icon {
      transform: scale(1.1) rotate(5deg);
    }
    
    /* Profile Progress Styles */
    .progress {
      background-color: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .progress-bar {
      transition: width 0.8s ease, background-color 0.3s ease;
      font-size: 0.75rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      position: relative;
    }
    
    .progress-bar.bg-danger {
      background: linear-gradient(45deg, #dc3545, #c82333) !important;
    }
    
    .progress-bar.bg-warning {
      background: linear-gradient(45deg, #ffc107, #e0a800) !important;
    }
    
    .progress-bar.bg-info {
      background: linear-gradient(45deg, #17a2b8, #138496) !important;
    }
    
    .progress-bar.bg-success {
      background: linear-gradient(45deg, #28a745, #1e7e34) !important;
    }
    
    .progress-bar.bg-primary {
      background: linear-gradient(45deg, #667eea, #764ba2) !important;
    }
    
    .profile-progress-card {
      transition: all 0.3s ease;
    }
    
    .profile-progress-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
    }
    
    .progress-percentage-badge {
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      border-radius: 20px;
    }
    
    .progress-tips {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-left: 4px solid #667eea;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
    }
    
    .missing-field {
      color: #dc3545;
      font-weight: 500;
    }
    
    .completed-field {
      color: #28a745;
      font-weight: 500;
    }
    
    @keyframes progressPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .progress-bar:not(.bg-success):hover {
      animation: progressPulse 1s ease-in-out;
    }
    
    /* Role Cards Styles */
    .role-card {
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }
    
    .role-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.15) !important;
      border-color: #e9ecef;
    }
    
    .role-card .card-body {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border-radius: 12px;
    }
    
    .role-card .role-icon {
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .role-card:hover .role-icon {
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .role-card .btn {
      transition: all 0.3s ease;
      border-radius: 8px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    .role-card .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .border-dashed {
      border-style: dashed !important;
      border-width: 2px !important;
    }
    
    .alert-light.border-dashed {
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
      border-color: #dee2e6 !important;
    }
  </style>
{% endblock css %}

{% block content %}
<!-- Profile Hero Section -->
<div class="profile-hero">
  <div class="container">
    <div class="row">
      <div class="col-12 text-center">
        <h1 class="display-5 fw-bold mb-2">
          {% if object == request.user %}
            Mi Perfil
          {% else %}
            Perfil de Usuario
          {% endif %}
        </h1>
        <p class="lead">
          {% if object == request.user %}
            Gestiona tu información personal y configuración de cuenta
          {% else %}
            Información del usuario
          {% endif %}
        </p>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <!-- Profile Card -->
  <div class="profile-card">
    <div class="row">
      <div class="col-md-4 text-center">
        <!-- Avatar -->
        <div class="profile-avatar">
          {% if object.avatar %}
            <img src="{{ object.avatar.url }}" alt="Avatar" style="width: 120px; height: 120px; object-fit: cover; border-radius: 50%; border: 5px solid white; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
          {% else %}
            {{ object.name|default:object.email|first|upper }}
          {% endif %}
        </div>
        <h3 class="mb-1">{{ object.name|default:"Usuario" }}</h3>
        <p class="text-muted">{{ object.email }}</p>
        {% if object.age %}
          <p class="text-muted"><i class="fas fa-birthday-cake me-1"></i>{{ object.age }} años</p>
        {% endif %}
        {% if object.location %}
          <p class="text-muted"><i class="fas fa-map-marker-alt me-1"></i>{{ object.location }}</p>
        {% endif %}
        {% if object.occupation %}
          <p class="text-muted"><i class="fas fa-briefcase me-1"></i>{{ object.occupation }}</p>
        {% endif %}
        
        {% if object == request.user %}
          <!-- Action buttons for own profile -->
          <div class="profile-actions mt-4">
            <a class="btn btn-primary" href="{% url 'users:update' %}">
              <i class="fas fa-edit me-2"></i>Editar Perfil
            </a>
            <a class="btn btn-outline-secondary" href="{% url 'events:my_events' %}">
              <i class="fas fa-ticket-alt me-2"></i>Mis Eventos
            </a>
            <a class="btn btn-outline-secondary" href="{% url 'account_change_password' %}">
              <i class="fas fa-key me-2"></i>Cambiar Contraseña
            </a>
          </div>
          
          <!-- Role Management Section -->
          <div class="mt-4">
            <h6 class="text-muted mb-3">
              <i class="fas fa-user-cog me-2"></i>Perfiles Profesionales
            </h6>
            
            <!-- Active Roles - Simplified -->
            {% if object.is_organizer or object.is_supplier %}
              <div class="row g-3">
                {% if object.is_organizer %}
                  <div class="col-md-6">
                    <div class="card h-100 border-0 shadow-sm role-card">
                      <div class="card-body text-center py-4">
                        <div class="role-icon bg-warning text-white rounded-circle mx-auto mb-3" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                          <i class="fas fa-cogs fa-lg"></i>
                        </div>
                        <h6 class="card-title">Organizador</h6>
                        <p class="card-text text-muted small mb-3">Gestiona eventos profesionalmente</p>
                        <a href="{% url 'users:manage_organizer_profile' %}" class="btn btn-warning btn-sm">
                          <i class="fas fa-cog me-1"></i>Gestionar Perfil Organizador
                        </a>
                      </div>
                    </div>
                  </div>
                {% endif %}
                
                {% if object.is_supplier %}
                  <div class="col-md-6">
                    <div class="card h-100 border-0 shadow-sm role-card">
                      <div class="card-body text-center py-4">
                        <div class="role-icon bg-success text-white rounded-circle mx-auto mb-3" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                          <i class="fas fa-handshake fa-lg"></i>
                        </div>
                        <h6 class="card-title">Proveedor/Patrocinador</h6>
                        <p class="card-text text-muted small mb-3">Patrocina y apoya eventos</p>
                        <a href="{% url 'users:manage_supplier_profile' %}" class="btn btn-success btn-sm">
                          <i class="fas fa-cog me-1"></i>Gestionar Perfil Proveedor
                        </a>
                      </div>
                    </div>
                  </div>
                {% endif %}
              </div>
            {% else %}
              <!-- No Active Roles -->
              <div class="alert alert-light border-2 border-dashed text-center py-4">
                <i class="fas fa-user-plus fa-2x text-muted mb-3"></i>
                <h6 class="text-muted">No tienes perfiles profesionales activos</h6>
                <p class="text-muted small mb-0">Solicita acceso a roles profesionales desde la sección de aplicaciones</p>
              </div>
            {% endif %}
            
            <!-- Role Applications Section -->
            {% if object.can_apply_for_organizer or object.can_apply_for_supplier or object.has_pending_organizer_application or object.has_pending_supplier_application %}
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                  <h6 class="mb-0">
                    <i class="fas fa-plus-circle me-2 text-primary"></i>Aplicaciones de Roles
                  </h6>
                </div>
                <div class="card-body">
                  <!-- Pending Applications Alert -->
                  {% if object.has_pending_organizer_application or object.has_pending_supplier_application %}
                    <div class="alert alert-info border-0 mb-4" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                      <div class="d-flex align-items-center">
                        <div class="me-3">
                          <i class="fas fa-clock fa-2x text-info"></i>
                        </div>
                        <div>
                          <h6 class="alert-heading mb-1">Aplicaciones Pendientes</h6>
                          <p class="mb-0">Tienes aplicaciones en proceso de revisión. Te notificaremos una vez que sean evaluadas.</p>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                  
                  <!-- Available Applications -->
                  <div class="row g-3">
                    {% if object.can_apply_for_organizer %}
                      <div class="col-md-6">
                        <div class="application-card h-100 p-3 border rounded-3" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-color: #ffb74d !important;">
                          <div class="text-center">
                            <div class="application-icon bg-warning text-white rounded-circle mx-auto mb-3" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                              <i class="fas fa-cogs fa-lg"></i>
                            </div>
                            <h6 class="fw-bold">Organizador de Eventos</h6>
                            <p class="text-muted small mb-3">Crea y gestiona tus propios eventos en la plataforma</p>
                            <div class="benefits mb-3">
                              <small class="d-block text-muted mb-1">
                                <i class="fas fa-check text-success me-1"></i>Panel de administración
                              </small>
                              <small class="d-block text-muted mb-1">
                                <i class="fas fa-check text-success me-1"></i>Gestión de tickets
                              </small>
                              <small class="d-block text-muted">
                                <i class="fas fa-check text-success me-1"></i>Analytics detallados
                              </small>
                            </div>
                            <a href="{% url 'users:apply_for_organizer' %}" class="btn btn-warning btn-sm w-100">
                              <i class="fas fa-paper-plane me-1"></i>Aplicar Ahora
                            </a>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                    
                    {% if object.can_apply_for_supplier %}
                      <div class="col-md-6">
                        <div class="application-card h-100 p-3 border rounded-3" style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); border-color: #81c784 !important;">
                          <div class="text-center">
                            <div class="application-icon bg-success text-white rounded-circle mx-auto mb-3" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                              <i class="fas fa-handshake fa-lg"></i>
                            </div>
                            <h6 class="fw-bold">Proveedor/Patrocinador</h6>
                            <p class="text-muted small mb-3">Ofrece servicios y patrocina eventos para hacer crecer tu negocio</p>
                            <div class="benefits mb-3">
                              <small class="d-block text-muted mb-1">
                                <i class="fas fa-check text-success me-1"></i>Perfil de empresa
                              </small>
                              <small class="d-block text-muted mb-1">
                                <i class="fas fa-check text-success me-1"></i>Oportunidades de patrocinio
                              </small>
                              <small class="d-block text-muted">
                                <i class="fas fa-check text-success me-1"></i>Red de contactos
                              </small>
                            </div>
                            <a href="{% url 'users:apply_for_supplier' %}" class="btn btn-success btn-sm w-100">
                              <i class="fas fa-paper-plane me-1"></i>Aplicar Ahora
                            </a>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  </div>
                  
                  {% if not object.can_apply_for_organizer and not object.can_apply_for_supplier and not object.has_pending_organizer_application and not object.has_pending_supplier_application %}
                    <div class="text-center py-4">
                      <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                      <h6>¡Ya tienes todos los roles disponibles!</h6>
                      <p class="text-muted mb-0">Puedes gestionar tus roles activos desde las opciones de arriba.</p>
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
      
      <div class="col-md-8">
        <!-- Profile Information -->
        <h4 class="mb-4">
          <i class="fas fa-info-circle me-2 text-primary"></i>Información del Perfil
        </h4>
        
        <div class="info-section">
          <div class="row">
            <div class="col-sm-6">
              <div class="info-label">Nombre completo</div>
              <div class="info-value">{{ object.name|default:"No especificado" }}</div>
            </div>
            <div class="col-sm-6">
              <div class="info-label">Email</div>
              <div class="info-value">
                {% if object.show_email or object == request.user %}
                  {{ object.email }}
                {% else %}
                  <i class="fas fa-lock me-1"></i>Privado
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        
        {% if object.bio %}
          <div class="info-section">
            <div class="info-label">
              <i class="fas fa-user-edit me-2 text-primary"></i>Biografía
            </div>
            <div class="info-value">{{ object.bio }}</div>
          </div>
        {% endif %}
        
        {% if object.full_phone or object.location or object.company %}
          <div class="info-section">
            <div class="row">
              {% if object.full_phone %}
                <div class="col-sm-6">
                  <div class="info-label">Teléfono</div>
                  <div class="info-value">
                    {% if object.show_phone or object == request.user %}
                      {{ object.full_phone }}
                    {% else %}
                      <i class="fas fa-lock me-1"></i>Privado
                    {% endif %}
                  </div>
                </div>
              {% endif %}
              {% if object.company %}
                <div class="col-sm-6">
                  <div class="info-label">Empresa</div>
                  <div class="info-value">{{ object.company }}</div>
                </div>
              {% endif %}
            </div>
          </div>
        {% endif %}
        
        {% if object.get_interests_display %}
          <div class="info-section">
            <div class="info-label">
              <i class="fas fa-star me-2 text-warning"></i>Intereses
            </div>
            <div class="info-value">
              {% for interest in object.get_interests_display %}
                <span class="badge bg-light text-dark me-1 mb-1">{{ interest }}</span>
              {% endfor %}
            </div>
          </div>
        {% endif %}
        
        {% if object.hobbies %}
          <div class="info-section">
            <div class="info-label">
              <i class="fas fa-gamepad me-2 text-success"></i>Hobbies
            </div>
            <div class="info-value">{{ object.hobbies }}</div>
          </div>
        {% endif %}
        
        <!-- Social Media Links -->
        {% if object.website or object.linkedin_url or object.twitter_url or object.instagram_url or object.facebook_url %}
          <div class="info-section">
            <div class="info-label">
              <i class="fas fa-share-alt me-2 text-info"></i>Enlaces
            </div>
            <div class="info-value">
              {% if object.website %}
                <a href="{{ object.website }}" target="_blank" class="btn btn-outline-primary btn-sm me-2 mb-2">
                  <i class="fas fa-link me-1"></i>Sitio web
                </a>
              {% endif %}
              {% if object.linkedin_url %}
                <a href="{{ object.linkedin_url }}" target="_blank" class="btn btn-outline-primary btn-sm me-2 mb-2">
                  <i class="fab fa-linkedin me-1"></i>LinkedIn
                </a>
              {% endif %}
              {% if object.twitter_url %}
                <a href="{{ object.twitter_url }}" target="_blank" class="btn btn-outline-info btn-sm me-2 mb-2">
                  <i class="fab fa-twitter me-1"></i>Twitter
                </a>
              {% endif %}
              {% if object.instagram_url %}
                <a href="{{ object.instagram_url }}" target="_blank" class="btn btn-outline-danger btn-sm me-2 mb-2">
                  <i class="fab fa-instagram me-1"></i>Instagram
                </a>
              {% endif %}
              {% if object.facebook_url %}
                <a href="{{ object.facebook_url }}" target="_blank" class="btn btn-outline-primary btn-sm me-2 mb-2">
                  <i class="fab fa-facebook me-1"></i>Facebook
                </a>
              {% endif %}
            </div>
          </div>
        {% endif %}
        
        <div class="info-section">
          <div class="row">
            <div class="col-sm-6">
              <div class="info-label">Fecha de registro</div>
              <div class="info-value">{{ object.date_joined|date:"d M Y" }}</div>
            </div>
            <div class="col-sm-6">
              <div class="info-label">Última actividad</div>
              <div class="info-value">{{ object.last_login|date:"d M Y, H:i"|default:"Nunca" }}</div>
            </div>
          </div>
        </div>
        
        <!-- User Roles Section -->
        {% if object.is_admin or object.is_organizer or object.is_supplier %}
          <div class="info-section">
            <div class="info-label">
              <i class="fas fa-user-tag me-2 text-primary"></i>Roles del Usuario
            </div>
            <div class="info-value">
              {% if object.is_admin %}
                <span class="badge bg-danger text-white px-3 py-2 me-2 mb-2">
                  <i class="fas fa-crown me-1"></i>Administrador
                </span>
              {% endif %}
              
              {% if object.is_organizer %}
                <span class="badge bg-warning text-dark px-3 py-2 me-2 mb-2">
                  <i class="fas fa-cogs me-1"></i>Organizador de Eventos
                </span>
                {% if object == request.user or object.organizer_profile.is_public %}
                  <a href="{% url 'users:organizer_profile' slug=object.organizer_profile.slug %}" 
                     class="btn btn-outline-warning btn-sm me-2 mb-2">
                    <i class="fas fa-eye me-1"></i>Ver Perfil de Organizador
                  </a>
                {% endif %}
              {% endif %}
              
              {% if object.is_supplier %}
                <span class="badge bg-success text-white px-3 py-2 me-2 mb-2">
                  <i class="fas fa-handshake me-1"></i>Proveedor/Patrocinador
                </span>
                {% if object == request.user or object.supplier_profile.is_public %}
                  <a href="{% url 'users:supplier_profile' slug=object.supplier_profile.slug %}" 
                     class="btn btn-outline-success btn-sm me-2 mb-2">
                    <i class="fas fa-eye me-1"></i>Ver Perfil de Proveedor
                  </a>
                {% endif %}
              {% endif %}
            </div>
          </div>
        {% endif %}
        
        <!-- Profile Progress Indicator -->
        <div class="mt-4">
          <div class="card border-0 shadow-sm profile-progress-card" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
            <div class="card-body text-center py-3">
              <h6 class="card-title mb-3">
                <i class="fas fa-chart-line me-2 text-primary"></i>
                Progreso del Perfil Personal
              </h6>
              <small class="text-muted d-block mb-3">
                Este progreso refleja la completitud de tu información personal básica
              </small>
              
              <!-- Calculate profile completion percentage -->
              {% with profile_fields=0 completed_fields=0 %}
                {% if object.name %}{% with completed_fields=completed_fields|add:1 %}{% endwith %}{% endif %}
                {% with profile_fields=profile_fields|add:1 %}{% endwith %}
                
                {% if object.avatar %}{% with completed_fields=completed_fields|add:1 %}{% endwith %}{% endif %}
                {% with profile_fields=profile_fields|add:1 %}{% endwith %}
                
                {% if object.bio %}{% with completed_fields=completed_fields|add:1 %}{% endwith %}{% endif %}
                {% with profile_fields=profile_fields|add:1 %}{% endwith %}
                
                {% if object.age %}{% with completed_fields=completed_fields|add:1 %}{% endwith %}{% endif %}
                {% with profile_fields=profile_fields|add:1 %}{% endwith %}
                
                {% if object.location %}{% with completed_fields=completed_fields|add:1 %}{% endwith %}{% endif %}
                {% with profile_fields=profile_fields|add:1 %}{% endwith %}
                
                {% if object.occupation %}{% with completed_fields=completed_fields|add:1 %}{% endwith %}{% endif %}
                {% with profile_fields=profile_fields|add:1 %}{% endwith %}
                
                {% if object.phone_number %}{% with completed_fields=completed_fields|add:1 %}{% endwith %}{% endif %}
                {% with profile_fields=profile_fields|add:1 %}{% endwith %}
                
                {% if object.date_of_birth %}{% with completed_fields=completed_fields|add:1 %}{% endwith %}{% endif %}
                {% with profile_fields=profile_fields|add:1 %}{% endwith %}
                
                <!-- Calculate percentage: Use JavaScript for better calculation -->
                <script>
                  document.addEventListener('DOMContentLoaded', function() {
                    const fields = {
                      name: {{ object.name|yesno:"true,false" }},
                      avatar: {{ object.avatar|yesno:"true,false" }},
                      bio: {{ object.bio|yesno:"true,false" }},
                      age: {{ object.age|yesno:"true,false" }},
                      location: "{{ object.location|default:'' }}" !== "",
                      occupation: "{{ object.occupation|default:'' }}" !== "",
                      phone: "{{ object.phone_number|default:'' }}" !== "",
                      birth_date: {{ object.date_of_birth|yesno:"true,false" }}
                    };
                    
                    const fieldLabels = {
                      name: 'Nombre completo',
                      avatar: 'Foto de perfil',
                      bio: 'Biografía',
                      age: 'Edad',
                      location: 'Ubicación',
                      occupation: 'Ocupación',
                      phone: 'Número de teléfono',
                      birth_date: 'Fecha de nacimiento'
                    };
                    
                    const totalFields = Object.keys(fields).length;
                    const completedFields = Object.values(fields).filter(Boolean).length;
                    const percentage = Math.round((completedFields / totalFields) * 100);
                    const missingFields = Object.keys(fields).filter(key => !fields[key]);
                    
                    // Update progress bar
                    const progressBar = document.getElementById('profile-progress-bar');
                    const progressText = document.getElementById('progress-percentage');
                    const progressLabel = document.getElementById('progress-label');
                    const tipsContainer = document.getElementById('progress-tips');
                    
                    if (progressBar && progressText && progressLabel) {
                      setTimeout(() => {
                        progressBar.style.width = percentage + '%';
                        progressBar.setAttribute('aria-valuenow', percentage);
                        progressText.textContent = percentage + '%';
                        
                        // Update color and label based on completion
                        if (percentage < 30) {
                          progressBar.className = 'progress-bar bg-danger';
                          progressLabel.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Perfil Incompleto';
                          progressText.className = 'badge bg-danger progress-percentage-badge fs-6 px-3 py-2';
                        } else if (percentage < 70) {
                          progressBar.className = 'progress-bar bg-warning';
                          progressLabel.innerHTML = '<i class="fas fa-clock me-1"></i>En Progreso';
                          progressText.className = 'badge bg-warning progress-percentage-badge fs-6 px-3 py-2';
                        } else if (percentage < 100) {
                          progressBar.className = 'progress-bar bg-info';
                          progressLabel.innerHTML = '<i class="fas fa-chart-line me-1"></i>Casi Completo';
                          progressText.className = 'badge bg-info progress-percentage-badge fs-6 px-3 py-2';
                        } else {
                          progressBar.className = 'progress-bar bg-success';
                          progressLabel.innerHTML = '<i class="fas fa-check-circle me-1"></i>¡Perfil Completo!';
                          progressText.className = 'badge bg-success progress-percentage-badge fs-6 px-3 py-2';
                        }
                        
                        // Show tips for missing fields
                        if (tipsContainer && missingFields.length > 0 && percentage < 100) {
                          let tipsHtml = '<div class="progress-tips mt-3"><h6 class="mb-2"><i class="fas fa-lightbulb me-1 text-warning"></i>Completa tu perfil agregando:</h6><ul class="list-unstyled mb-0">';
                          missingFields.slice(0, 3).forEach(field => {
                            tipsHtml += `<li class="missing-field"><i class="fas fa-plus-circle me-1"></i>${fieldLabels[field]}</li>`;
                          });
                          if (missingFields.length > 3) {
                            tipsHtml += `<li class="text-muted"><i class="fas fa-ellipsis-h me-1"></i>Y ${missingFields.length - 3} campos más...</li>`;
                          }
                          tipsHtml += '</ul></div>';
                          tipsContainer.innerHTML = tipsHtml;
                        } else if (tipsContainer && percentage === 100) {
                          tipsContainer.innerHTML = '<div class="progress-tips mt-3 text-center"><h6 class="text-success mb-0"><i class="fas fa-trophy me-1"></i>¡Excelente! Tu perfil está completo</h6></div>';
                        }
                      }, 500);
                    }
                  });
                </script>
                
                <div class="progress mb-3" style="height: 12px; border-radius: 10px;">
                  <div id="profile-progress-bar" 
                       class="progress-bar bg-primary" 
                       role="progressbar" 
                       style="width: 0%; border-radius: 10px; transition: width 0.8s ease;" 
                       aria-valuenow="0" 
                       aria-valuemin="0" 
                       aria-valuemax="100">
                  </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                  <small id="progress-label" class="text-muted fw-bold">
                    <i class="fas fa-spinner fa-spin me-1"></i>Calculando...
                  </small>
                  <span id="progress-percentage" class="badge bg-primary progress-percentage-badge fs-6 px-3 py-2">0%</span>
                </div>
                
                {% if object == request.user %}
                  <div class="mt-3">
                    <div class="d-flex justify-content-center">
                      <a href="{% url 'users:update' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-edit me-1"></i>Editar Perfil Personal
                      </a>
                    </div>
                    <small class="text-muted d-block mt-2">
                      Completa tu información personal básica (nombre, foto, biografía, etc.)
                    </small>
                  </div>
                  
                  <!-- Progress Tips Container -->
                  <div id="progress-tips"></div>
                {% endif %}
              {% endwith %}
            </div>
          </div>
        </div>
        
        {% if object == request.user %}
          <!-- Actions for own profile view -->
          <div class="mt-4">
            <a href="{% url 'events:list' %}" class="btn btn-outline-primary">
              <i class="fas fa-arrow-left me-2"></i>Volver a Eventos
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock content %}
